<form>
    <div class="form-inline">
        <span>開始日</span>
        <input type="date" class="form-control ml-1" id="faxed-from-date-input"/>
        <span class="ml-2">終了日</span>
        <input type="date" class="form-control ml-1" id="faxed-upto-date-input"/>
    </div>
    <div class="form-inline mt-2">
        <span class="mr-2">ラベル開始</span>
        <label class="col-form-label">列</label>
        <input type="number" class="form-control col-2 ml-1" id="faxed-row-input" value="1"/>
        <label class="col-form-label ml-2">行</label>
        <input type="number" class="form-control col-2 ml-1" id="faxed-col-input" value="1"/>
    </div>
    <div class="form-inline mt-2">
        <button type="button" class="btn btn-primary form-control" id="faxed-create-button">すべて作成</button>
    </div>
</form>

<div id="faxed-progress-report" class="alert alert-info alert-dismissible my-3 d-none" role="alert">
    <div class="faxed-part-message"></div>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div id="faxed-error-report" class="card mt-3 d-none">
    <div class="card-header text-white bg-danger">エラー</div>
    <div class="card-body"></div>
</div>

<div id="faxed-data-file-status" class="faxed-group-status card mt-3">
    <div class="card-header">データ</div>
    <div class="card-body">
        <div class="faxed-part-message"></div>
        <div class="form-inline mt-2">
            <button type="button" class="btn btn-link faxed-part-create">作成</button>
        </div>
    </div>
</div>

<div id="faxed-shohousen-pdf-status" class="faxed-group-status card mt-3">
    <div class="card-header">処方箋ＰＤＦ</div>
    <div class="card-body">
        <div class="faxed-part-message"></div>
        <div class="form-inline mt-2">
            <button type="button" class="btn btn-link faxed-part-create">作成</button>
            <button type="button" class="btn btn-link faxed-part-display">表示</button>
        </div>
    </div>
</div>

<div id="faxed-pharma-letter-pdf-status" class="faxed-group-status card mt-3">
    <div class="card-header">薬局レターＰＤＦ</div>
    <div class="card-body">
        <div class="faxed-part-message"></div>
        <div class="form-inline mt-2">
            <button type="button" class="btn btn-link faxed-part-create">作成</button>
            <button type="button" class="btn btn-link faxed-part-display">表示</button>
        </div>
    </div>
</div>

<div id="faxed-pharma-label-pdf-status" class="faxed-group-status card mt-3">
    <div class="card-header">薬局住所ラベルＰＤＦ</div>
    <div class="card-body">
        <div class="faxed-part-message"></div>
        <div class="form-inline mt-2">
            <button type="button" class="btn btn-link faxed-part-create">作成</button>
            <button type="button" class="btn btn-link faxed-part-display">表示</button>
        </div>
    </div>
</div>

<div id="faxed-clinic-label-pdf-status" class="faxed-group-status card mt-3">
    <div class="card-header">クリニック住所ラベルＰＤＦ</div>
    <div class="card-body">
        <div class="faxed-part-message"></div>
        <div class="form-inline mt-2">
            <button type="button" class="btn btn-link faxed-part-create">作成</button>
            <button type="button" class="btn btn-link faxed-part-display">表示</button>
        </div>
    </div>
</div>

<script>
    (function () {

        function shohousenUrl(path) {
            return "../integration/faxed-shohousen-data/" + path;
        }

        function getLastGroup() {
            return ajaxGet(shohousenUrl("get-last-group"));
        }

        function getGroup(from, upto) {
            return ajaxGet(shohousenUrl("get-group") + `?from=${from}&upto=${upto}`)
        }

        function countShohousen(from, upto) {
            return ajaxGet(shohousenUrl("count-shohousen") + `?from=${from}&upto=${upto}`);
        }

        function createData(from, upto) {
            return ajaxPost(shohousenUrl("create-data") + `?from=${from}&upto=${upto}`);
        }

        function createShohousenText(from, upto) {
            return ajaxPost(shohousenUrl("create-shohousen-text") + `?from=${from}&upto=${upto}`);
        }

        function createShohousenPdf(from, upto) {
            return ajaxPost(shohousenUrl("create-shohousen-pdf") + `?from=${from}&upto=${upto}`);
        }

        function createPharmaLetterText(from, upto) {
            return ajaxPost(shohousenUrl("create-pharma-letter-text") + `?from=${from}&upto=${upto}`);
        }

        function createPharmaLetterPdf(from, upto) {
            return ajaxPost(shohousenUrl("create-pharma-letter-pdf") + `?from=${from}&upto=${upto}`);
        }

        function createPharmaLabelPdf(from, upto, row, col) {
            return ajaxPost(shohousenUrl("create-pharma-label-pdf") +
                `?from=${from}&upto=${upto}&row=${row}&col=${col}`);
        }

        function createClinicLabelPdf(from, upto, row, col, n) {
            return ajaxPost(shohousenUrl("create-clinic-label-pdf") +
                `?from=${from}&upto=${upto}&row=${row}&col=${col}&n=${n}`);
        }

        function setFromValue(from) {
            $("#faxed-from-date-input").val(from);
        }

        function getFromValue(from) {
            return $("#faxed-from-date-input").val();
        }

        function setUptoValue(upto) {
            $("#faxed-upto-date-input").val(upto);
        }

        function getUptoValue(upto) {
            return $("#faxed-upto-date-input").val();
        }

        function getRowValue() {
            let val = parseInt($("#faxed-row-input").val());
            if (isNaN(val)) {
                throw `Invalid row value`;
            } else {
                return val;
            }
        }

        function getColValue() {
            let val = parseInt($("#faxed-col-input").val());
            if (isNaN(val)) {
                throw `Invalid col value`;
            } else {
                return val;
            }
        }

        $("#faxed-create-button").on("click", event => createAll());

        class ProgressReport {
            constructor(){
                this.ele = $("#faxed-progress-report");
            }

            hide(){
                this.ele.addClass("d-none");
            }

            show(){
                this.ele.removeClass("d-none");
            }

            report(message){
                this.ele.find(".faxed-part-message").text(message);
                if( message ){
                    this.show();
                } else {
                    this.hide();
                }
            }
        }

        let progressReport = new ProgressReport();

        class ErrorReport {
            constructor() {
                this.ele = $("#faxed-error-report");
            }

            show() {
                this.ele.removeClass("d-none");
            }

            hide() {
                this.ele.addClass("d-none");
            }

            findBody() {
                return this.ele.find(".card-body");
            }

            setBody(body) {
                this.findBody().html("").append(body);
                if (body) {
                    this.show();
                } else {
                    this.hide();
                }
            }
        }

        let errorReport = new ErrorReport();

        class StatusReport {
            constructor(ele, prefix) {
                this.ele = ele;
                this.prefix = prefix;
            }

            setMessage(message) {
                this.ele.find(".faxed-part-message").text(message);
            }

            updateByObject(groupInfo) {
                this.update(groupInfo[this.prefix], groupInfo[this.prefix + "Size"],
                    groupInfo[this.prefix + "LastModifiedAt"])
            }

            update(file, size, modifiedAt) {
                let text = "";
                if (file) {
                    text = `作成済。file: ${file}, size: ${size}, modifiedAt: ${modifiedAt}`;
                } else {
                    text = "未作成。";
                }
                this.setMessage(text);
            }
        }

        let dataStatusReport = new StatusReport($("#faxed-data-file-status"),
            "dataFile");
        let shohousenPdfStatusReport = new StatusReport($("#faxed-shohousen-pdf-status"),
            "shohousenPdfFile");
        let pharmaLetterPdfStatusReport = new StatusReport($("#faxed-pharma-letter-pdf-status"),
            "pharmaLetterPdfFile");
        let pharmaLabelPdfStatusReport = new StatusReport($("#faxed-pharma-label-pdf-status"),
            "pharmaLabelPdfFile");
        let clinicLabelPdfStatusReport = new StatusReport($("#faxed-clinic-label-pdf-status"),
            "clinicLabelPdfFile");

        async function createAll() {
            let from = getFromValue();
            let upto = getUptoValue();
            if (!(from && upto)) {
                return;
            }
            let errs = [];
            progressReport.report("データを作成しています...");
            let result = await createData(from, upto);
            if (!result.success) {
                errs.push(result.errorMessage);
            } else {
                progressReport.report("処方箋テキストを作成しています...");
                result = await createShohousenText(from, upto);
                if (!result.success) {
                    errs.push(result.errorMessage);
                } else {
                    progressReport.report("処方箋ＰＤＦを作成しています...");
                    result = await createShohousenPdf(from, upto);
                    if (!result.success) {
                        errs.push(result.errorMessage);
                    }
                }
                progressReport.report("処方箋レターのエキストを作成しています...");
                result = await createPharmaLetterText(from, upto);
                if (!result.success) {
                    errs.push(result.errorMessage);
                } else {
                    progressReport.report("処方箋レターＰＤＦを作成しています...");
                    result = await createPharmaLetterPdf(from, upto);
                    if (!result.success) {
                        errs.push(result.errorMessage);
                    }
                }
                let row = getRowValue();
                let col = getColValue();
                progressReport.report("薬局住所ラベルＰＤＦを作成しています...");
                result = await createPharmaLabelPdf(from, upto, row, col);
                if (!result.success) {
                    errs.push(result.errorMessage);
                }
                let n = await countShohousen(from, upto);
                progressReport.report("クリニック住所ラベルＰＤＦを作成しています...");
                result = await createClinicLabelPdf(from, upto, row, col, n);
                if (!result.success) {
                    errs.push(result.errorMessage);
                }
            }

            if (errs.length > 0) {
                let wrapper = $("<div>", {class: "my-3"});
                errs.forEach(err => {
                    let e = $("<div>", {class: "my-2"}).text(err);
                    wrapper.append(e);
                })
                errorReport.setBody(wrapper);
            } else {
                progressReport.report("すべて作成しました。");
            }
            updateStatus(await getGroup(from, upto));
        }

        function guessNextDates(lastUpdate) {
            let momentLast = moment(lastUpdate);
            let momentStart = momentLast.add(1, "day");
            let momentEnd = momentStart.clone();
            if (momentStart.date() < 15) {
                momentEnd.date(15);
            } else {
                momentEnd = momentEnd.endOf("month");
            }
            return [momentStart.format("YYYY-MM-DD"), momentEnd.format("YYYY-MM-DD")];
        }

        async function guessNextTarget() {
            let lastGroup = await getLastGroup();
            if (lastGroup) {
                if (lastGroup.completed) {
                    let target = {};
                    [target.from, target.upto] = guessNextDates(lastGroup.upto);
                    return target;
                } else {
                    return lastGroup;
                }
            } else {
                return {};
            }

        }

        function updateStatus(group) {
            dataStatusReport.updateByObject(group);
            shohousenPdfStatusReport.updateByObject(group);
            pharmaLetterPdfStatusReport.updateByObject(group);
            pharmaLabelPdfStatusReport.updateByObject(group);
            clinicLabelPdfStatusReport.updateByObject(group);
        }

        async function setup() {
            let target = await guessNextTarget()
            setFromValue(target.from);
            setUptoValue(target.upto);
            updateStatus(target);
        }

        setup();
    })();
</script>