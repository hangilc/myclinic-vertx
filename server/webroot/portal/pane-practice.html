<!--suppress ALL -->
<div class="row">
    <h3 class="col-sm-2">診察</h3>
    <div class="col-sm-10">
        <div class="dropdown ml-auto" id="practice-select-patient-menu">
            <button class="btn btn-secondary dropdown-toggle" type="button"
                    data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false">
                患者選択
            </button>
            <div class="dropdown-menu x-menu" aria-labelledby="dropdownMenuButton">
                <button class="btn btn-link x-wqueue">受付患者選択</button>
                <button class="btn btn-link x-search">患者検索</button>
                <button class="btn btn-link x-recent">最近の診察</button>
                <button class="btn btn-link x-today">本日の診察</button>
                <button class="btn btn-link x-prev">以前の診察</button>
            </div>
        </div>
    </div>
</div>

<div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true"
     id="practice-choose-patient-dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">患者選択</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="x-search_">
                    <form class="form-inline x-form">
                        <input class="form-control x-input"/>
                        <button type="submit" class="form-control ml-2">検索</button>
                    </form>
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="card mt-2">
                    <div class="card-body">
                        <div class="row x-display_">
                            <div class="col-sm-3">患者番号</div>
                            <div class="col-sm-9 x-patient-id"></div>
                            <div class="col-sm-3">氏名</div>
                            <div class="col-sm-9">
                                <span class="x-last-name"></span><span
                                    class="x-first-name"></span>
                            </div>
                            <div class="col-sm-3">よみ</div>
                            <div class="col-sm-9 x-yomi">
                                <span class="x-last-name-yomi"></span><span
                                    class="x-first-name-yomi"></span>
                            </div>
                            <div class="col-sm-3">生年月日</div>
                            <div class="col-sm-9">
                                <span class="x-birthday"></span>
                                <span class="x-age"></span>
                            </div>
                            <div class="col-sm-3">性別</div>
                            <div class="col-sm-9 x-sex"></div>
                            <div class="col-sm-3">住所</div>
                            <div class="col-sm-9 x-address"></div>
                            <div class="col-sm-3">電話</div>
                            <div class="col-sm-9 x-phone"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary x-register-enter">受付・診察</button>
                <button type="button" class="btn btn-primary x-enter">選択</button>
                <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<div id="practice-patient-info" class="d-none mx-2">
    [<span class="x-patient-id"></span>]
    <span class="x-last-name"></span><span class="x-first-name"></span>
    (<span class="x-last-name-yomi"></span><span class="x-first-name-yomi"></span>)
    <span class="x-birthday"></span>生
    (<span class="x-age"></span>才)
    <span class="x-sex"></span>性
    <button type="button" class="x-detail-link btn btn-link">詳細</button>
    <div class="x-detail d-none row">
        <div class="col-sm-3">住所</div>
        <div class="x-address col-sm-9"></div>
        <div class="col-sm-3">電話番号</div>
        <div class="x-phone col-sm-9"></div>
    </div>
</div>

<div id="practice-patient-manip" class="d-none mx-2 form-inline">
    <button type="button" class="x-cashier btn btn-secondary">会計</button>
    <button type="button" class="x-end btn btn-secondary ml-2">患者終了</button>
    <button type="button" class="x-search-text btn btn-link ml-2">文章検索</button>
    <button type="button" class="x-refer btn btn-link">紹介状作成</button>
</div>

<div id="practice-record-wrapper"></div>

<template id="practice-record-template">
    <div class="practice-record">
        <div class="x-title"></div>
        <div class="row">
            <div class="x-left_ col-sm-6 rp-1">
                <div class="x-text-wrapper"></div>
                <div class="x-command-wrapper">
                    <a href="javascript:void(0)" class="x-enter-text">［文章入力］</a>
                </div>
            </div>
            <div class="x-right_ col-sm-6 lp-1">
                <div class="x-hoken-wrapper"></div>
                <div>
                    <a href="javascript:void(0)" class="x-shinryou-menu">［診療行為］</a>
                    <a href="javascript:void(0)" class="x-shinryou-aux-menu">［＋］</a>
                </div>
                <div class="x-shinryou-wrapper"></div>
                <a href="javascript:void(0)" class="x-shochi-menu">［処置］</a>
                <div class="x-shochi-wrapper"></div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-wqueue-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">受付患者選択</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-recent-visit-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">最近の診察</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-todays-visit-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">本日の診察</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-visit-at-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">以前の診察</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-inline">
                        <span>診察日</span>
                        <input type="date" class="x-date ml-1"/>
                    </div>
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-shinryou-regular-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">診療行為入力</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row x-checks">
                        <div class="col-sm-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="初診"
                                       id="practice-shinryou-regular-初診"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-初診">
                                    初診
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="再診"
                                       id="practice-shinryou-regular-再診"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-再診">
                                    再診
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="外来管理加算"
                                       id="practice-shinryou-regular-外来管理加算"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-外来管理加算">
                                    外来管理加算
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="特定疾患管理"
                                       id="practice-shinryou-regular-特定疾患管理"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-特定疾患管理">
                                    特定疾患管理
                                </label>
                            </div>
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input" value="尿便検査判断料"
                                       id="practice-shinryou-regular-尿便検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-尿便検査判断料">
                                    尿便検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="血液検査判断料"
                                       id="practice-shinryou-regular-血液検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-血液検査判断料">
                                    血液検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="生化Ⅰ判断料"
                                       id="practice-shinryou-regular-生化Ⅰ判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-生化Ⅰ判断料">
                                    生化Ⅰ判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="生化Ⅱ判断料"
                                       id="practice-shinryou-regular-生化Ⅱ判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-生化Ⅱ判断料">
                                    生化Ⅱ判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="免疫検査判断料"
                                       id="practice-shinryou-regular-免疫検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-免疫検査判断料">
                                    免疫検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="微生物検査判断料"
                                       id="practice-shinryou-regular-微生物検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-微生物検査判断料">
                                    微生物検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="静脈採血"
                                       id="practice-shinryou-regular-静脈採血"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-静脈採血">
                                    静脈採血
                                </label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="尿一般"
                                       id="practice-shinryou-regular-尿一般"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-尿一般">
                                       尿一般
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="便潜血"
                                       id="practice-shinryou-regular-便潜血"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-便潜血">
                                       便潜血
                                </label>
                            </div>
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input"
                                       value="処方箋料"
                                       id="practice-shinryou-regular-処方箋料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-処方箋料">
                                       処方箋料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="特定疾患処方管理加算２（処方箋料）"
                                       id="practice-shinryou-regular-特定疾患処方管理加算２（処方箋料）"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-特定疾患処方管理加算２（処方箋料）">
                                       特定疾患処方管理加算２（処方箋料）
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="一般名処方加算２（処方箋料）"
                                       id="practice-shinryou-regular-一般名処方加算２（処方箋料）"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-一般名処方加算２（処方箋料）">
                                       一般名処方加算２（処方箋料）
                                </label>
                            </div>
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input"
                                       value="処方料"
                                       id="practice-shinryou-regular-処方料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-処方料">
                                       処方料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="処方料７"
                                       id="practice-shinryou-regular-処方料７"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-処方料７">
                                       処方料７
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="手帳記載加算"
                                       id="practice-shinryou-regular-手帳記載加算"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-手帳記載加算">
                                       手帳記載加算
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="特定疾患処方"
                                       id="practice-shinryou-regular-特定疾患処方"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-特定疾患処方">
                                       特定疾患処方
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="長期処方"
                                       id="practice-shinryou-regular-長期処方"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-長期処方">
                                       長期処方
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="内服調剤"
                                       id="practice-shinryou-regular-内服調剤"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-内服調剤">
                                       内服調剤
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="外用調剤"
                                       id="practice-shinryou-regular-外用調剤"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-外用調剤">
                                       外用調剤
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="調基"
                                       id="practice-shinryou-regular-調基"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-調基">
                                       調基
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="薬剤情報提供"
                                       id="practice-shinryou-regular-薬剤情報提供"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-薬剤情報提供">
                                       薬剤情報提供
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        Foot Row
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">入力</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-title-template">
    <div class="mt-2 practice-title form-inline">
        <div class="x-text"></div>
        <div class="dropdown ml-auto">
            <button class="btn btn-link dropdown-toggle" type="button"
                    data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false">
                操作
            </button>
            <div class="dropdown-menu x-menu" aria-labelledby="dropdownMenuButton">
            </div>
        </div>
    </div>
</template>

<template id="practice-hoken-template">
    <div></div>
</template>

<template id="practice-text-template">
    <div class="my-1"></div>
</template>

<template id="practice-enter-text-template">
    <div class="mt-2">
        <textarea class="form-control x-textarea" rows="6"></textarea>
        <div class="form-inline">
            <button type="button" class="btn btn-link x-enter">入力</button>
            <button type="button" class="btn btn-link x-cancel">キャンセル</button>
        </div>
    </div>
</template>

<template id="practice-edit-text-template">
    <div class="mt-2">
        <textarea class="form-control x-textarea" rows="6"></textarea>
        <div class="form-inline">
            <button type="button" class="btn btn-link x-enter">入力</button>
            <button type="button" class="btn btn-link x-cancel">キャンセル</button>
            <button type="button" class="btn btn-link x-delete">削除</button>
            <button type="button" class="btn btn-link x-shohousen">処方箋発行</button>
            <button type="button" class="btn btn-link x-shohousen-fax">処方箋FAX</button>
            <button type="button" class="btn btn-link x-copy">コピー</button>
        </div>
    </div>
    </div>
</template>

<template id="practice-shohousen-preview-dialog-template">
    <div class="modal" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">処方箋</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-disp" style="width:148mm;height:210mm"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-print">印刷</button>
                    <button type="button" class="btn btn-secondary x-close">閉じる</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-shinryou-template">
    <div>
        <div class="x-text"></div>
    </div>
</template>

<script>

    (async function () {
        let {parseElement} = await import("./practice/parse-element.js");
        let modChoosePatientDialog = await import("./practice/choose-patient-dialog.js");
        let modPatientDisplay = await import("./practice/patient-display.js");
        let modDrawerSvg = await import("./js/drawer-svg.js");
        let {CurrentVisitManager} = await import("./practice/current-visit-manager.js");
        let {CurrentPatientManager} = await import("./practice/current-patient-manager.js");
        let {Component} = await import("./practice/component.js");
        let {Title} = await import("./practice/title.js");
        let {SelectWqueueDialog} = await import("./practice/select-wqueue-dialog.js");
        let {SelectRecentVisitDialog} = await import("./practice/select-recent-visit-dialog.js");
        let {SelectTodaysVisitDialog} = await import("./practice/select-todays-visit-dialog.js");
        let {SelectPreviousVisitDialog} = await import("./practice/select-prev-visit-dialog.js");
        let {ShinryouRegularDialog} = await import("./practice/shinryou-regular-dialog.js");
        let {Shinryou} = await import("./practice/shinryou.js");
        let {Text} = await import("./practice/text.js");
        let {Record} = await import("./practice/record.js");
        let {Hoken} = await import("./practice/hoken.js");
        let {TextEnter} = await import("./practice/text-enter.js");
        let {TextEdit} = await import("./practice/text-edit.js");
        let {ShohousenPreviewDialog} = await import("./practice/shohousen-preview-dialog.js");

        let currentVisitManager = new CurrentVisitManager();
        let currentPatientManager = new CurrentPatientManager();

        function getTemplateHtml(templateId) {
            let html = $("template#" + templateId).html();
            if (!html) {
                console.error(`cannot find "${templateId}"`);
            }
            return html;
        }

        function assert(value) {
            if (!value) {
                throw new Error("assetion failed.");
            }
        }

        currentVisitManager.onChanged((event, info) => console.log("currentVisitChanged", info));
        currentPatientManager.onChanged((event, info) => console.log("currentPatientChanged", info));

        let choosePatientDialog = (function () {
            let ele = $("#practice-choose-patient-dialog");
            let map = parseElement(ele);
            return new modChoosePatientDialog.ChoosePatientDialog(map, rest);
        })();

        let selectWqueueDialog = (function () {
            let html = getTemplateHtml("practice-select-wqueue-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectWqueueDialog(ele, map, rest);
            dialog.init(state => wqueueStateCodeToRep(state));
            return dialog;
        })();

        let selectRecentVisitDialog = (function () {
            let html = getTemplateHtml("practice-select-recent-visit-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectRecentVisitDialog(ele, map, rest);
            dialog.init();
            return dialog;
        })();

        let selectTodaysVisitDialog = (function () {
            let html = getTemplateHtml("practice-select-todays-visit-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectTodaysVisitDialog(ele, map, rest);
            dialog.init();
            return dialog;
        })();

        let selectPreviousVisitDialog = (function () {
            let html = getTemplateHtml("practice-select-visit-at-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectPreviousVisitDialog(ele, map, rest);
            dialog.init();
            return dialog;
        })();

        let shinryouRegularDialog = (function () {
            let html = getTemplateHtml("practice-shinryou-regular-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new ShinryouRegularDialog(ele, map, rest);
            dialog.init();
            return dialog;
        })();

        class PatientInfo {
            constructor(ele, map) {
                this.ele = ele;
                this.map = map;
                this.detail = map.detail;
                map.detailLink.on("click", event => this.toggleDetail());
                this.display = new modPatientDisplay.PatientDisplay(map);
            }

            setPatient(patient) {
                this.display.setPatient(patient);
            }

            clear() {
                this.display.clear();
            }

            show() {
                this.ele.removeClass("d-none");
            }

            hide() {
                this.ele.addClass("d-none");
            }

            showDetail() {
                this.detail.removeClass("d-none");
            }

            hideDetail() {
                this.detail.addClass("d-none");
            }

            toggleDetail() {
                if (this.detail.hasClass("d-none")) {
                    this.showDetail();
                } else {
                    this.hideDetail();
                }
            }
        }

        (function () {
            let ele = $("#practice-patient-info");
            let map = parseElement(ele);
            let patientInfo = new PatientInfo(ele, map);
            currentPatientManager.onChanged(async (event, patientId) => {
                if (patientId === 0) {
                    patientInfo.hide();
                    patientInfo.clear();
                } else {
                    let patient = await rest.getPatient(patientId);
                    patientInfo.setPatient(patient);
                    patientInfo.show();
                }
            });
        })();

        (function () {
            let ele = $("#practice-patient-manip");
            let map = parseElement(ele);

            map.cashier.on("click", event => {
                console.log("cashier");
            });

            map.end.on("click", async event => {
                currentPatientManager.setCurrentPatientId(0);
                await suspendCurrentVisit();
                currentVisitManager.setCurrentVisitId(0);
            });

            map.searchText.on("click", event => {
                console.log("search text");
            });

            map.refer.on("click", event => {
                console.log("refer");
            });

            currentPatientManager.onChanged((event, patientId) => {
                if (patientId === 0) {
                    ele.addClass("d-none");
                } else {
                    ele.removeClass("d-none");
                }
            });
        })();

        let copyTargetResolver = {
            resolve(){
                let currentVisitId = currentVisitManager.getCurrentVisitId();
                if( currentVisitId > 0 ){
                    return currentVisitId;
                } else {
                    return currentVisitManager.getTempVisitId();
                }
            }
        };

        class TitleFactory {
            constructor() {
                this.html = $("template#practice-title-template").html();
                this.rest = rest;
                this.currentVisitManager = currentVisitManager;
            }

            create(visit) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Title(ele, map, rest);
                comp.init(visit, "current-visit", "temp-visit");
                if (visit.visitId === currentVisitManager.getCurrentVisitId()) {
                    comp.markAsCurrent();
                } else if (visit.visitId === currentVisitManager.getTempVisitId()) {
                    comp.markAsTemp();
                }
                return comp;
            }
        }

        class TextEnterFactory {
            constructor() {
                this.html = getTemplateHtml("practice-enter-text-template");
            }

            create(visitId) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new TextEnter(ele, map, rest);
                comp.init(visitId);
                return comp;
            }
        }

        class TextFactory {
            constructor() {
                this.html = $("template#practice-text-template").html();
                this.rest = rest;
                this.copyTargetResolver = copyTargetResolver;
                this.textEditFactory = new TextEditFactory();
            }

            create(text) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Text(ele, map, this.rest);
                comp.init(text);
                ele.on("click", event => {
                    let editor = this.textEditFactory.create(text);
                    editor.onUpdated((event, updated) => {
                        let compUpdated = this.create(updated);
                        compUpdated.replace(editor.ele);
                    });
                    editor.onCancel(event => comp.replace(editor.ele));
                    editor.onDeleted(event => editor.remove());
                    editor.onCopied((event, copiedText) => {
                        comp.replace(editor.ele);
                        let target = findRecord(copiedText.visitId);
                        if( target ){
                            target.addText(copiedText);
                        }
                    });
                    editor.replace(comp.ele);
                });
                return comp;
            }
        }

        class HokenFactory {
            constructor() {
                this.html = getTemplateHtml("practice-hoken-template");
            }

            create(hokenRep) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let compHoken = new Hoken(ele, map, rest);
                compHoken.init(hokenRep);
                return compHoken;
            }
        }

        class ShinryouFactory {
            constructor(){
                this.html = getTemplateHtml("practice-shinryou-template");
            }

            create(shinryouFull){
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Shinryou(ele, map, rest);
                comp.init(shinryouFull);
                return comp;
            }
        }

        class ShohousenPreviewDialogFactory {
            constructor(){
                this.html = getTemplateHtml("practice-shohousen-preview-dialog-template");
                this.drawerSvgModule = modDrawerSvg;
            }

            create(ops){
                let ele = $(this.html);
                let map = parseElement(ele);
                let dialog = new ShohousenPreviewDialog(ele, map, rest);
                dialog.init(ops, this.drawerSvgModule);
                return dialog;
            }
        }

        class TextEditFactory {
            constructor() {
                this.html = getTemplateHtml("practice-edit-text-template");
                this.rest = rest;
                this.copyTargetResolver = copyTargetResolver;
                this.shohousenPreviewDialogFactory = new ShohousenPreviewDialogFactory();
            }

            create(text) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new TextEdit(ele, map, this.rest);
                comp.init(text, this.copyTargetResolver, this.shohousenPreviewDialogFactory);
                return comp;
            }
        }

        class RecordFactory {
            constructor(){
                this.html = getTemplateHtml("practice-record-template");
                this.wrapper = $("#practice-record-wrapper");
                this.titleFactory = new TitleFactory();
                this.textFactory = new TextFactory();
                this.textEnterFactory = new TextEnterFactory();
                this.hokenFactory = new HokenFactory();
                this.shinryouFactory = new ShinryouFactory();
            }

            create(visitFull, hokenRep){
                let ele = $(this.html);
                let map = parseElement(ele);
                let record = new Record(ele, map, rest);
                record.init(visitFull, hokenRep, this.titleFactory, this.textFactory,
                    this.hokenFactory, this.shinryouFactory, this.textEnterFactory);
                record.onDeleted(event => record.remove());
                record.onTempVisit(event =>
                    currentVisitManager.setTempVisitId(visitFull.visit.visitId));
                record.onClearTempVisit(event => currentVisitManager.setTempVisitId(0));
                return record;
            }
        }

        async function suspendCurrentVisit() {
            let curr = currentVisitManager.getCurrentVisitId();
            if (curr > 0) {
                await rest.suspendExam(curr);
            }
        }

        async function startPatient(patientId) {
            await suspendCurrentVisit();
            currentVisitManager.setCurrentVisitId(0);
            currentPatientManager.setCurrentPatientId(patientId);
        }

        async function startVisit(visitId) {
            await suspendCurrentVisit();
            currentVisitManager.setCurrentVisitId(visitId);
            let visit = await rest.getVisit(visitId);
            currentPatientManager.setCurrentPatientId(visit.patientId);
        }

        (function () {
            let map = parseElement($("#practice-select-patient-menu"));
            map.wqueue.on("click", async event => {
                let result = await selectWqueueDialog.open();
                if (result.mode === "selected") {
                    let wqueueFull = result.data;
                    let visitId = wqueueFull.visit.visitId
                    await rest.startExam(visitId);
                    await startVisit(visitId);
                }
            });
            map.search.on("click", async event => {
                let result = await choosePatientDialog.open();
                if (result.mode === "enter") {
                    let patient = result.patient;
                    currentVisitManager.setCurrentVisitId(0);
                    currentPatientManager.setCurrentPatientId(patient.patientId);
                } else if (result.mode === "register-enter") {
                    let visitId = result.visitId;
                    let curr = currentVisitManager.getCurrentVisitId();
                    if (curr > 0) {
                        await rest.suspendExam(curr);
                    }
                    await rest.startExam(visitId);
                    currentVisitManager.setCurrentVisitId(result.visitId);
                    let patient = result.patient;
                    currentPatientManager.setCurrentPatientId(patient.patientId);
                }
            });
            map.recent.on("click", async event => {
                let result = await selectRecentVisitDialog.open();
                if (result.mode === "selected") {
                    let patient = result.data.patient;
                    await startPatient(patient.patientId);
                }
            });
            map.today.on("click", async event => {
                let result = await selectTodaysVisitDialog.open();
                if (result.mode === "selected") {
                    let patient = result.data.patient;
                    await startPatient(patient.patientId);
                }
            });
            map.prev.on("click", async event => {
                let result = await selectPreviousVisitDialog.open();
                if (result.mode === "selected") {
                    let patient = result.data.patient;
                    await startPatient(patient.patientId);
                }
            });
        })();

        let recordFactory = new RecordFactory();

        async function getHokenRep(hoken){
            let hokenRep = await rest.hokenRep(hoken);
            if( hokenRep == "" ){
                hokenRep = "［保険なし］"
            }
            return hokenRep;
        }

        currentPatientManager.onChanged(async (event, patientId) => {
            let recordWrapperElement = $("#practice-record-wrapper").html("");
            if (patientId > 0) {
                let page = await rest.listVisit(patientId, 0);
                for (let visitFull of page.visits) {
                    let hokenRep = await getHokenRep(visitFull.hoken);
                    let record = recordFactory.create(visitFull, hokenRep);
                    record.appendTo(recordWrapperElement);
                }
            }
        });

        function forEachRecord(f){
            let xs = $(".practice-record");
            let len = xs.length;
            for(let i=0;i<len;i++){
                let x = xs.slice(i, i+1);
                let c = x.data("component");
                f(c);
            }
        }

        function findRecord(visitId){
            let xs = $(".practice-record");
            let len = xs.length;
            for(let i=0;i<len;i++){
                let x = xs.slice(i, i+1);
                let c = x.data("component");
                if( c.getVisitId() === visitId ){
                    return c;
                }
            }
            return null;
        }

        currentVisitManager.onChanged((event, info) => {
            let {currentVisitId, tempVisitId} = info;
            forEachRecord(record => {
                if (record.getVisitId() === currentVisitId) {
                    record.markAsCurrent();
                } else if (record.getVisitId() === tempVisitId) {
                    record.markAsTemp();
                } else {
                    record.clearMark();
                }
            });
        });


    })();

</script>