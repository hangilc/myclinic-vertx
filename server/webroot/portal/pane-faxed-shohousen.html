<form>
    <div class="form-inline">
        <span>開始日</span>
        <input type="date" class="form-control ml-1" id="faxed-from-date-input"/>
        <span class="ml-2">終了日</span>
        <input type="date" class="form-control ml-1" id="faxed-upto-date-input"/>
    </div>
    <div class="form-inline mt-2">
        <button type="button" class="btn btn-primary form-control" id="faxed-create-button">作成</button>
    </div>
</form>

<div id="faxed-no-pharma-error" class="faxed-creation-error d-none">
    <div class="alert alert-danger mt-3">
        <h5>薬局を見つけられません</h5>
    </div>
    <div id="faxed-no-pharma-patient"></div>
    <div id="faxed-no-pharma-visited-at"></div>
    <div id="faxed-no-pharma-texts"></div>
</div>

<ul class="nav nav-tabs mt-3">
    <li class="nav-item">
        <a class="nav-link active" href="javascript:void(0)">処理済一覧</a>
    </li>
</ul>
<div id="faxed-nav-content"></div>

<template id="tmpl-text">
    <div></div>
</template>

<template id="tmpl-textex">
    <div>
        <div part="content"></div>
        <div part="commands">
            <button part="command-edit">編集</button>
        </div>
    </div>
</template>

<template id="tmpl-textform">
    <div>
        <textarea></textarea>
        <div part="commands">
            <button part="enter">入力</button>
            <button part="cancel">キャンセル</button>
        </div>
    </div>
</template>

<script>
    function compText(content){
        let e = $($("#tmpl-text").html());
        e.html(content.replace(/\n/g, "<br/>"));
        return {
            ele: e
        };
    }

    function compTextForm(text){
        let e = $($("#tmpl-textform").html());
        let $textarea = e.find("textarea");
        $textarea.html(text.content);
        let comp = {
            ele: e,
            $textarea: $textarea,
            $commands: e.find("[part=enter]"),
            $enter: e.find("[part=enter]"),
            $cancel: e.find("[part=cancel]"),
            onEnter: () => {},
            onCanel: () => {}
        };
        comp.$enter.on("click", event => {
            comp.onEnter(comp.$textarea.val());
        })
        comp.$cancel.on("click", event => {
            comp.onCancel();
        });
        return comp;
    }

    function compTextEx(text) {
        let e = $($("#tmpl-textex").html());
        let $content = e.find("[part=content]").html(text.content.replace(/\n/g, "<br/>"));
        let $editButton = e.find("[part=command-edit]");
        let comp = {
            ele: e,
            $content: $content,
            $commandBox: e.find("[part=commands]"),
            $editButton: $editButton,
            onFormCreated: form => {},
            onFormEnter: content => {}
        }
        $editButton.on("click", event => {
            let form = compTextForm(text);
            comp.onFormCreated(form);
            e.after(form.ele);
            e.detach();
            form.onEnter = content => comp.onFormEnter(content);
            form.onCancel = () => {
                form.ele.replaceWith(e);
            };
        });
        return comp;
    }

    (function () {
        function ajaxGet(url, data) {
            return new Promise((resolve, fail) => {
                $.ajax({
                    type: "GET",
                    url: url,
                    data: data,
                    cache: false,
                    dataType: "json",
                    success: resolve,
                    error: (xhr, status, err) => fail(err)
                });
            });
        }

        function ajaxPost(url, data) {
            return new Promise((resolve, fail) => {
                $.ajax({
                    type: "POST",
                    url: url,
                    data: JSON.stringify(data),
                    cache: false,
                    dataType: "json",
                    success: resolve,
                    error: (xhr, status, err) => fail(err)
                });
            });
        }

        function getPrevGroups() {
            return ajaxGet("../integration/faxed-shohousen-data/list-groups");
        }

        async function doSubmenuPrevGroups() {
            let prevGroups = await getPrevGroups();
            let ul = $("<ul>");
            if (prevGroups) {
                prevGroups.forEach(group => {
                    let li = $("<li>").text(group);
                    ul.append(li);
                });
            }
            $("#faxed-nav-content").html("").append(ul);
        }

        async function chooseNextGroup() {
            let prevGroups = await getPrevGroups();
            let momentLast = null;
            prevGroups.forEach(group => {
                let upto = group.split("-")[1];
                let momentUpto = moment(upto, "YYYYMMDD");
                if (momentLast == null) {
                    momentLast = momentUpto;
                } else {
                    if (momentUpto.isAfter(momentLast)) {
                        momentLast = momentUpto;
                    }
                }
            });
            if (momentLast == null) {
                return null;
            } else {
                let momentStart = momentLast.add(1, "day");
                let momentEnd = momentStart.clone();
                if (momentStart.date() < 15) {
                    momentEnd.date(15);
                } else {
                    momentEnd = momentEnd.endOf("month");
                }
                return {
                    from: momentStart,
                    upto: momentEnd
                }
            }
        }

        async function setup() {
            let nextGroup = await chooseNextGroup();
            if (nextGroup) {
                $("#faxed-from-date-input").val(nextGroup.from.format("YYYY-MM-DD"));
                $("#faxed-upto-date-input").val(nextGroup.upto.format("YYYY-MM-DD"));
            }
        }

        function showNoPharma(patient, visit, texts) {
            let name = patient.lastName + patient.firstName;
            let visitedAt = moment(visit.visitedAt);
            $("#faxed-no-pharma-patient").text("患者：" + name);
            $("#faxed-no-pharma-visited-at").text("診察日：" + visitedAt.format("YYYY-MM-DD"));
            let textWrapper = $("#faxed-no-pharma-texts").html("");
            texts.forEach(text => {
                let c = compTextEx(text);
                let e = c.ele;
                e.addClass("border border-secondary rounded my-2 p-2");
                c.$commandBox.addClass("mt-2");
                c.onFormCreated = form => {
                    form.ele.addClass("form-group border border-warning rounded p-2");
                    form.$textarea.addClass("form-control").attr("rows", "7");
                    form.$commands.addClass("mt-2");
                };
                c.onFormEnter = async content => {
                    let newText = $.extend({}, text);
                    newText.content = content;
                    await ajaxPost("../json/update-text", newText);
                };
                textWrapper.append(e);
            });
            $("#faxed-no-pharma-error").removeClass("d-none");
        }

        $("#faxed-create-button").on("click", async event => {
            let data = {
                from: $("#faxed-from-date-input").val(),
                upto: $("#faxed-upto-date-input").val()
            };
            let result = await ajaxGet("../integration/faxed-shohousen-data/create-data", data);
            $(".faxed-creation-error").addClass("d-none");
            if (result.stderr) {
                let reWithoutPharma = /presc without pharma\s+<Visit\(visit_id='(\d+)'/;
                let match = reWithoutPharma.exec(result.stderr);
                if (match) {
                    let visitId = match[1];
                    let visit = await ajaxGet("../json/get-visit", {"visit-id": visitId});
                    let patient = await ajaxGet("../json/get-patient", {"patient-id": visit.patientId});
                    let texts = await ajaxGet("../json/list-text", {"visit-id": visitId});
                    showNoPharma(patient, visit, texts);
                } else {
                    console.log(result.stderr);
                }
            } else {
                console.log(result.stdout);
            }
        });

        setup();
        doSubmenuPrevGroups();

    })();
</script>


