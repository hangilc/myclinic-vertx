<!--suppress ALL -->
<!-- TODO: register current patient -->
<!-- TODO: add receipt detail menu to title -->
<div class="row" id="practice-top">
    <h3 class="col-xl-2">診察</h3>
    <div class="col-xl-10 form-inline">
        <div class="dropdown" id="practice-select-patient-menu">
            <button class="btn btn-secondary dropdown-toggle" type="button"
                    data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false">
                患者選択
            </button>
            <div class="dropdown-menu x-menu" aria-labelledby="dropdownMenuButton">
                <a href="javascript:void(0)" class="x-wqueue dropdown-item mx-2">受付患者選択</a>
                <a href="javascript:void(0)" class="x-search dropdown-item mx-2">患者検索</a>
                <a href="javascript:void(0)" class="x-recent dropdown-item mx-2">最近の診察</a>
                <a href="javascript:void(0)" class="x-today dropdown-item mx-2">本日の診察</a>
                <a href="javascript:void(0)" class="x-prev dropdown-item mx-2">以前の診察</a>
            </div>
        </div>
        <a href="javascript:void(0)" class="ml-2" id="practice-search-text-globally">全文検索</a>
    </div>
</div>

<div id="practice-patient-info" class="d-none mx-2 my-2">
    [<span class="x-patient-id"></span>]
    <span class="x-last-name"></span><span class="x-first-name"></span>
    (<span class="x-last-name-yomi"></span><span class="x-first-name-yomi"></span>)
    <span class="x-birthday"></span>生
    (<span class="x-age"></span>才)
    <span class="x-sex"></span>性
    <a href="javascript:void(0)" class="x-detail-link">詳細</a>
    <div class="x-detail d-none row">
        <div class="col-sm-3">住所</div>
        <div class="x-address col-sm-9"></div>
        <div class="col-sm-3">電話番号</div>
        <div class="x-phone col-sm-9"></div>
    </div>
</div>

<div id="practice-patient-manip" class="d-none mx-2 form-inline">
    <button class="x-cashier btn btn-secondary">会計</button>
    <button class="x-end  ml-2 btn btn-secondary">患者終了</button>
    <a href="javascript:void(0)" class="x-register-current  ml-2">診察登録</a>
    <a href="javascript:void(0)" class="x-search-text  ml-2">文章検索</a>
    <a href="javascript:void(0)" class="x-refer ml-2">紹介状作成</a>
</div>

<div id="practice-nav-upper"></div>

<div class="row">
    <div id="practice-record-wrapper" class="col-xl-9"></div>
    <div id="practice-right-bar" class="col-xl-3">
        <div id="practice-disease-wrapper"></div>
        <div id="practice-general-workarea"></div>
    </div>
</div>

<div id="practice-nav-lower"></div>

<template id="practice-record-template">
    <div class="practice-record">
        <div class="x-title"></div>
        <div class="row">
            <div class="x-left_ col-sm-6 rp-1">
                <div class="x-text-wrapper"></div>
                <div class="x-command-wrapper">
                    <a href="javascript:void(0)" class="x-enter-text">［文章入力］</a>
                    <a href="javascript:void(0)" class="x-send-shohousen-fax">処方箋FAX</a>
                </div>
            </div>
            <div class="x-right_ col-sm-6 lp-1">
                <div class="x-hoken-wrapper"></div>
                <div class="x-drug-mark d-none">Rp）</div>
                <div class="x-drug-wrapper"></div>
                <div class="form-inline">
                    <a href="javascript:void(0)" class="x-shinryou-menu">［診療行為］</a>
                    <div class="dropdown">
                        <button type="button" class="btn btn-link dropdown-toggle"
                            data-toggle="dropdown">その他</button>
                        <div class="dropdown-menu x-shinryou-aux-menu_">
                            <a href="javascript:void(0)" class="x-copy-all dropdown-item">全部コピー</a>
                        </div>
                    </div>
                </div>
                <div class="x-shinryou-wrapper"></div>
                <a href="javascript:void(0)" class="x-conduct-menu">［処置］</a>
                <div class="x-conduct-wrapper"></div>
                <div class="x-charge-wrapper"></div>
            </div>
        </div>
    </div>
</template>

<template id="practice-patient-search-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">患者選択</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-search_">
                        <form class="form-inline x-form">
                            <input class="form-control x-input"/>
                            <button type="submit" class="form-control ml-2">検索</button>
                        </form>
                        <select class="form-control mt-2 form-control x-select" size="5"></select>
                    </div>
                    <div class="card mt-2">
                        <div class="card-body">
                            <div class="row x-disp_">
                                <div class="col-sm-3">患者番号</div>
                                <div class="col-sm-9 x-patient-id"></div>
                                <div class="col-sm-3">氏名</div>
                                <div class="col-sm-9">
                                    <span class="x-last-name"></span><span
                                        class="x-first-name ml-2"></span>
                                </div>
                                <div class="col-sm-3">よみ</div>
                                <div class="col-sm-9 x-yomi">
                                    <span class="x-last-name-yomi"></span><span
                                        class="x-first-name-yomi ml-2"></span>
                                </div>
                                <div class="col-sm-3">生年月日</div>
                                <div class="col-sm-9 x-birthday"></div>
                                <div class="col-sm-3">性別</div>
                                <div class="col-sm-9 x-sex"></div>
                                <div class="col-sm-3">住所</div>
                                <div class="col-sm-9 x-address"></div>
                                <div class="col-sm-3">電話</div>
                                <div class="col-sm-9 x-phone"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-register-enter">受付・診察</button>
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-wqueue-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">受付患者選択</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-recent-visit-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">最近の診察</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-todays-visit-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">本日の診察</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-select-visit-at-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">以前の診察</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-inline">
                        <span>診察日</span>
                        <input type="date" class="x-date ml-1"/>
                    </div>
                    <select class="form-control mt-2 form-control x-select" size="5"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-shinryou-regular-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">診療行為入力</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row x-checks">
                        <div class="col-sm-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="初診"
                                       id="practice-shinryou-regular-初診"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-初診">
                                    初診
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="再診"
                                       id="practice-shinryou-regular-再診"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-再診">
                                    再診
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="外来管理加算"
                                       id="practice-shinryou-regular-外来管理加算"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-外来管理加算">
                                    外来管理加算
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="特定疾患管理"
                                       id="practice-shinryou-regular-特定疾患管理"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-特定疾患管理">
                                    特定疾患管理
                                </label>
                            </div>
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input" value="尿便検査判断料"
                                       id="practice-shinryou-regular-尿便検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-尿便検査判断料">
                                    尿便検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="血液検査判断料"
                                       id="practice-shinryou-regular-血液検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-血液検査判断料">
                                    血液検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="生化Ⅰ判断料"
                                       id="practice-shinryou-regular-生化Ⅰ判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-生化Ⅰ判断料">
                                    生化Ⅰ判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="生化Ⅱ判断料"
                                       id="practice-shinryou-regular-生化Ⅱ判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-生化Ⅱ判断料">
                                    生化Ⅱ判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="免疫検査判断料"
                                       id="practice-shinryou-regular-免疫検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-免疫検査判断料">
                                    免疫検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="微生物検査判断料"
                                       id="practice-shinryou-regular-微生物検査判断料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-微生物検査判断料">
                                    微生物検査判断料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" value="静脈採血"
                                       id="practice-shinryou-regular-静脈採血"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-静脈採血">
                                    静脈採血
                                </label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="尿一般"
                                       id="practice-shinryou-regular-尿一般"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-尿一般">
                                    尿一般
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="便潜血"
                                       id="practice-shinryou-regular-便潜血"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-便潜血">
                                    便潜血
                                </label>
                            </div>
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input"
                                       value="処方箋料"
                                       id="practice-shinryou-regular-処方箋料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-処方箋料">
                                    処方箋料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="特定疾患処方管理加算２（処方箋料）"
                                       id="practice-shinryou-regular-特定疾患処方管理加算２（処方箋料）"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-特定疾患処方管理加算２（処方箋料）">
                                    特定疾患処方管理加算２（処方箋料）
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="一般名処方加算２（処方箋料）"
                                       id="practice-shinryou-regular-一般名処方加算２（処方箋料）"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-一般名処方加算２（処方箋料）">
                                    一般名処方加算２（処方箋料）
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="一般名処方加算１（処方箋料）"
                                       id="practice-shinryou-regular-一般名処方加算１（処方箋料）"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-一般名処方加算１（処方箋料）">
                                    一般名処方加算１（処方箋料）
                                </label>
                            </div>
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input"
                                       value="処方料"
                                       id="practice-shinryou-regular-処方料"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-処方料">
                                    処方料
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="処方料７"
                                       id="practice-shinryou-regular-処方料７"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-処方料７">
                                    処方料７
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="手帳記載加算"
                                       id="practice-shinryou-regular-手帳記載加算"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-手帳記載加算">
                                    手帳記載加算
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="特定疾患処方"
                                       id="practice-shinryou-regular-特定疾患処方"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-特定疾患処方">
                                    特定疾患処方
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="長期処方"
                                       id="practice-shinryou-regular-長期処方"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-長期処方">
                                    長期処方
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="内服調剤"
                                       id="practice-shinryou-regular-内服調剤"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-内服調剤">
                                    内服調剤
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="外用調剤"
                                       id="practice-shinryou-regular-外用調剤"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-外用調剤">
                                    外用調剤
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="調基"
                                       id="practice-shinryou-regular-調基"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-調基">
                                    調基
                                </label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="薬剤情報提供"
                                       id="practice-shinryou-regular-薬剤情報提供"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-薬剤情報提供">
                                    薬剤情報提供
                                </label>
                            </div>
                        </div>
                        <div class="col-sm-12 form-inline">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       value="向精神薬"
                                       id="practice-shinryou-regular-向精神薬"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-向精神薬">
                                    向精神薬
                                </label>
                            </div>
                            <div class="form-check ml-2">
                                <input type="checkbox" class="form-check-input"
                                       value="心電図"
                                       id="practice-shinryou-regular-心電図"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-心電図">
                                    心電図
                                </label>
                            </div>
                            <div class="form-check ml-2">
                                <input type="checkbox" class="form-check-input"
                                       value="骨塩定量"
                                       id="practice-shinryou-regular-骨塩定量"/>
                                <label class="form-check-label"
                                       for="practice-shinryou-regular-骨塩定量">
                                    骨塩定量
                                </label>
                            </div>
                        </div>
                    </div>
                    <div>
                        Foot Row
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">入力</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-title-template">
    <div class="mt-2 practice-title form-inline">
        <div class="x-text"></div>
        <div class="dropdown ml-auto">
            <button class="btn btn-link dropdown-toggle" type="button"
                    data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false">
                操作
            </button>
            <div class="dropdown-menu x-menu" aria-labelledby="dropdownMenuButton">
            </div>
        </div>
    </div>
</template>

<template id="practice-hoken-template">
    <div></div>
</template>

<template id="practice-text-template">
    <div class="my-1"></div>
</template>

<template id="practice-text-disp-template">
    <div class="my-1"></div>
</template>

<template id="practice-enter-text-template">
    <div class="mt-2">
        <textarea class="form-control x-textarea" rows="6"></textarea>
        <div class="form-inline">
            <a href="javascript:void(0)" class="x-enter">入力</a>
            <a href="javascript:void(0)" class="x-cancel ml-2">キャンセル</a>
        </div>
    </div>
</template>

<template id="practice-edit-text-template">
    <div class="mt-2">
        <textarea class="form-control x-textarea" rows="6"></textarea>
        <div class="form-inline">
            <a href="javascript:void(0)" class="x-enter">入力</a>
            <a href="javascript:void(0)" class="x-cancel ml-2">キャンセル</a>
            <a href="javascript:void(0)" class="x-delete ml-2">削除</a>
            <a href="javascript:void(0)" class="x-shohousen ml-2">処方箋発行</a>
            <a href="javascript:void(0)" class="x-shohousen-fax ml-2">処方箋FAX</a>
            <a href="javascript:void(0)" class="x-copy ml-2">コピー</a>
        </div>
    </div>
</template>

<template id="practice-shohousen-preview-dialog-template">
    <div class="modal" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">処方箋</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-disp" style="width:148mm;height:210mm"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-print">印刷</button>
                    <button type="button" class="btn btn-secondary x-close">閉じる</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-shinryou-template">
    <div class="practice-shinryou"></div>
</template>

<template id="practice-shinryou-disp-template">
    <div></div>
</template>

<template id="practice-shinryou-edit-template">
    <div class="border border-secondary rounded p-2 my-2">
        <div>名称：<span class="x-label"></span></div>
        <div class="mt-2">
            <button class="btn btn-secondary x-delete">削除</button>
            <button class="btn btn-secondary x-cancel">キャンセル</button>
        </div>
    </div>
</template>

<template id="practice-conduct-disp-template">
    <div>
        <div class="x-kind"></div>
        <div class="x-gazou-label"></div>
        <div class="x-shinryou"></div>
        <div class="x-drug"></div>
        <div class="x-kizai"></div>
    </div>
</template>

<template id="practice-drug-disp-template">
    <div><span class="x-index"></span>）<span class="x-rep"></span></div>
</template>

<template id="practice-meisai-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">会計</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-detail_">
                        <pre class="x-items"></pre>
                        <div class="x-summary"></div>
                        <div class="x-value"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-enter">入力</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-send-fax-template">
    <div class="border founded mb-3 p-2">
        <div class="mt-2">
            <span class="x-pdf-file"></span>
            <a href="javascript:void(0)" class="x-view">プレビュー</a>
        </div>
        <div class="x-fax-number"></div>
        <div class="mt-4">
            <button class="btn btn-secondary x-send">送信</button>
            <a href="javascript:void(0)" class="x-cancel ml-2">キャンセル</a>
        </div>
    </div>
</template>

<template id="practice-fax-progress-template">
    <div class="border founded mb-3 p-2">
        <div class="x-title"></div>
        <div class="mt-2">
            <span class="x-pdf-file"></span>
            <a href="javascript:void(0)" class="x-view">表示</a>
        </div>
        <div class="x-fax-number"></div>
        <div class="x-message mt-4"></div>
        <div class="mt-4">
            <button class="btn btn-secondary x-re-send">再送信</button>
            <a href="javascript:void(0)" class="x-close ml-2">閉じる</a>
        </div>
    </div>
</template>

<template id="practice-charge-template">
    <div class="mt-2"></div>
</template>

<template id="practice-charge-disp-template">
    <div></div>
</template>

<template id="practice-nav-template">
    <div class="d-none mt-2">
        <a href="javascript:void(0)" class="x-first">最初</a>
        <a href="javascript:void(0)" class="x-prev ml-1">前へ</a>
        <a href="javascript:void(0)" class="x-next ml-1">次へ</a>
        <a href="javascript:void(0)" class="x-last ml-1 mr-1">最後</a>
        [<span class="x-page"></span>/<span class="x-total"></span>]
    </div>
</template>

<template id="practice-disease-area-template">
    <div class="d-none">
        <h5>病名</h5>
        <div class="x-workarea"></div>
        <div class="x-commands mt-2">
            <a href="javascript:void(0)" class="x-current">現行</a>
            <a href="javascript:void(0)" class="x-add">追加</a>
            <a href="javascript:void(0)" class="x-end">転機</a>
            <a href="javascript:void(0)" class="x-edit">編集</a>
        </div>
    </div>
</template>

<template id="practice-disease-add-template">
    <div>
        <div>
            名称：<span class="x-name"></span>
        </div>
        <div class="mt-1">
            <input type="date" class="x-date-input form-control"></input>
        </div>
        <div class="mt-1">
            <button type="button" class="x-enter btn btn-secondary">入力</button>
            <a href="javascript:void(0)" class="x-susp">の疑い</a>
            <a href="javascript:void(0)" class="x-del-adj">修飾語削除</a>
        </div>
        <form class="x-search-form mt-1">
            <div class="form-inline">
                <input type="text" class="x-search-text form-control"/>
                <button type="submit" class="btn btn-secondary mt-1">検索</button>
                <a href="javascript:void(0)" class="x-example mt-1 ml-2">例</a>
            </div>
            <div class="mt-1" onsubmit="return false">
                <input type="radio" name="search-kind" class="x-disease-radio" checked> 病名
                <input type="radio" name="search-kind" class="x-adj-radio"> 修飾語
            </div>
        </form>
        <div class="mt-1">
            <select size="10" class="x-select form-control"></select>
        </div>
    </div>
</template>

<template id="practice-disease-end-template">
    <div>
        <div class="x-list"></div>
        <div>
            <input type="date" class="x-date-input form-control"/>
            <div class="x-date-commands_">
                <a href="javascript:void(0)" class="x-advance-week">週</a>
                <a href="javascript:void(0)" class="x-today">今日</a>
                <a href="javascript:void(0)" class="x-end-of-month">月末</a>
                <a href="javascript:void(0)" class="x-end-of-last-month">先月末</a>
            </div>
        </div>
        <div>
            <form class="form-inline x-end-reason-form" onsubmit="return false">
                転機：
                <input type="radio" name="end-reason" value="C" checked>
                <span class="ml-1">治癒</span>
                <input type="radio" name="end-reason" value="S" class="ml-2">
                <span class="ml-1">中止</span>
                <input type="radio" name="end-reason" value="D" class="ml-2">
                <span class="ml-1">死亡</span>
            </form>
        </div>
        <div>
            <button type="button" class="x-enter btn btn-secondary">入力</button>
        </div>
    </div>
</template>

<template id="practice-disease-edit-template">
    <div>
        <div class="x-panel_">
            <div>名称：<span class="x-name"></span></div>
            <div>開始日：<span class="x-start-date"></span></div>
            <div>転機：<span class="x-end-reason"></span></div>
            <div>終了日：<span class="x-end-date"></span></div>
        </div>
        <div class="mt-1">
            <button type="button" class="x-edit btn btn-secondary">編集</button>
        </div>
        <select class="form-control x-select mt-1" size="6"></select>
    </div>
</template>

<template id="practice-disease-modify-template">
    <div>
        <div>
            名前：<span class="x-name"></span>
        </div>
        <div>
            <input type="date" class="x-start-date form-control"/>
        </div>
        <div>から</div>
        <div>
            <input type="date" class="x-end-date form-control"/>
        </div>
        <div class="form-inline">
            <select class="x-end-reason-select form-control">
                <option value="N">継続</option>
                <option value="C">治癒</option>
                <option value="S">中止</option>
                <option value="D">死亡</option>
            </select>
        </div>
        <div class="mt-1">
            <button type="button" class="x-enter btn btn-secondary">入力</button>
            <a href="javascript:void(0)" class="x-susp">の疑い</a>
            <a href="javascript:void(0)" class="x-del-adj">修飾語削除</a>
            <a href="javascript:void(0)" class="x-clear-end-date">終了日クリア</a>
            <a href="javascript:void(0)" class="x-delete">削除</a>
        </div>
        <div class="x-search_">
            <form class="x-form mt-1">
                <div class="form-inline">
                    <input type="text" class="x-search-text form-control"/>
                    <button type="submit" class="btn btn-secondary mt-1">検索</button>
                    <a href="javascript:void(0)" class="x-example mt-1 ml-2">例</a>
                </div>
                <div class="mt-1" onsubmit="return false">
                    <input type="radio" name="search-kind"
                           value="byoumei" checked> 病名
                    <input type="radio" name="search-kind"
                           value="adj"> 修飾語
                </div>
            </form>
            <div class="mt-1">
                <select size="10" class="x-select form-control"></select>
            </div>
        </div>
    </div>
</template>

<template id="practice-search-text-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title x-title"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form class="x-search-form form-inline">
                        <input type="text" class="x-search-text form-control"/>
                        <button type="submit" class="btn btn-primary ml-2">検索</button>
                    </form>
                    <div class="x-nav_ d-none mt-2">
                        <a href="javascript:void(0)" class="x-first">最初</a>
                        <a href="javascript:void(0)" class="x-prev ml-1">前へ</a>
                        <a href="javascript:void(0)" class="x-next ml-1">次へ</a>
                        <a href="javascript:void(0)" class="x-last ml-1 mr-1">最後</a>
                        [<span class="x-page"></span>/<span class="x-total"></span>]
                    </div>
                    <div class="x-result"></div>
                </div>
            </div>
        </div>
        <template class="x-item-template">
            <div class="my-2 border border-secondary rounded p-2">
                <div class="x-title_ bg-light font-weight-bold p-1">
                    <div class="x-text"></div>
                </div>
                <div class="x-text_ mt-2">
                    <div></div>
                </div>
            </div>
        </template>
        <template class="x-global-item-template">
            <div class="my-2 border border-secondary rounded p-2">
                <div class="x-title_ bg-light font-weight-bold p-1">
                    <span class="x-patient text-primary"></span> <span class="x-text ml-2"></span>
                </div>
                <div class="x-text_ mt-2">
                    <div></div>
                </div>
            </div>
        </template>
    </div>
</template>

<script>

    (async function () {
        let {parseElement} = await import("./practice/parse-element.js");
        let {PatientDisplay} = await import("./practice/patient-display.js");
        let DrawerSvg = await import("./js/drawer-svg.js");
        let {Component} = await import("./practice/component.js");
        let {Title} = await import("./practice/title.js");
        let {SelectWqueueDialog} = await import("./practice/select-wqueue-dialog.js");
        let {SelectRecentVisitDialog} = await import("./practice/select-recent-visit-dialog.js");
        let {SelectTodaysVisitDialog} = await import("./practice/select-todays-visit-dialog.js");
        let {SelectPreviousVisitDialog} = await import("./practice/select-prev-visit-dialog.js");
        let {ShinryouRegularDialog} = await import("./practice/shinryou-regular-dialog.js");
        let {ShinryouDisp} = await import("./practice/shinryou-disp.js");
        let {Shinryou} = await import("./practice/shinryou.js");
        let {ShinryouEdit} = await import("./practice/shinryou-edit.js");
        let {Text} = await import("./practice/text.js");
        let {TextDisp} = await import("./practice/text-disp.js");
        let {TextEnter} = await import("./practice/text-enter.js");
        let {TextEdit} = await import("./practice/text-edit.js");
        let {Record} = await import("./practice/record.js");
        let {Hoken} = await import("./practice/hoken.js");
        let {ShohousenPreviewDialog} = await import("./practice/shohousen-preview-dialog.js");
        let {ConductDisp} = await import("./practice/conduct-disp.js");
        let {DrugDisp} = await import("./practice/drug-disp.js");
        let {MeisaiDialog} = await import("./practice/meisai-dialog.js");
        let {SendFax} = await import("./practice/send-fax.js");
        let {FaxProgress} = await import("./practice/fax-progress.js");
        let {Charge} = await import("./practice/charge.js");
        let {ChargeDisp} = await import("./practice/charge-disp.js");
        let {Nav} = await import("./practice/nav.js");
        let {DiseaseArea} = await import("./practice/disease-area.js");
        let {DiseaseCurrent} = await import("./practice/disease-current.js");
        let {DiseaseAdd, initDiseaseExamples} = await import("./practice/disease-add.js");
        let {DiseaseEnd} = await import("./practice/disease-end.js");
        let {DiseaseEdit} = await import("./practice/disease-edit.js");
        let {DiseaseModify} = await import("./practice/disease-modify.js");
        let {DiseasePanel} = await import("./practice/disease-panel.js");
        let {SearchTextForPatientDialog} = await import("./practice/search-text-for-patient-dialog.js");
        let {SearchTextGloballyDialog} = await import("./practice/search-text-globally-dialog.js");
        let {PracticeState} = await import("./practice/practice-state.js");
        let {PatientSearchDialog} = await import("./practice/patient-search-dialog.js");

        let practiceState = new PracticeState(rest);

        class CurrentVisitManager {
            resolveCopyTarget(){
                return practiceState.getVisitId() || practiceState.getTempVisitId();
            }
        }

        let currentVisitManager = new CurrentVisitManager();

        let getCurrentPatientId = practiceState.getPatientId();

        function getTemplateHtml(templateId) {
            let html = $("template#" + templateId).html();
            if (!html) {
                console.error(`cannot find "${templateId}"`);
            }
            return html;
        }

        class PatientSearchDialogFactory {
            create(){
                let html = $("template#practice-patient-search-dialog-template").html();
                let ele = $(html);
                let map = parseElement(ele);
                let dialog = new PatientSearchDialog(ele, map, rest);
                dialog.init();
                return dialog;
            }
        }

        let selectWqueueDialog = (function () {
            let html = getTemplateHtml("practice-select-wqueue-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectWqueueDialog(ele, map, rest);
            dialog.init(state => wqueueStateCodeToRep(state));
            return dialog;
        })();

        let selectRecentVisitDialog = (function () {
            let html = getTemplateHtml("practice-select-recent-visit-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectRecentVisitDialog(ele, map, rest);
            dialog.init();
            return dialog;
        })();

        let selectTodaysVisitDialog = (function () {
            let html = getTemplateHtml("practice-select-todays-visit-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectTodaysVisitDialog(ele, map, rest);
            dialog.init();
            return dialog;
        })();

        let selectPreviousVisitDialog = (function () {
            let html = getTemplateHtml("practice-select-visit-at-dialog-template");
            let ele = $(html);
            let map = parseElement(ele);
            let dialog = new SelectPreviousVisitDialog(ele, map, rest);
            dialog.init();
            return dialog;
        })();

        class SearchTextGloballyDialogFactory {
            constructor() {
                this.html = getTemplateHtml("practice-search-text-dialog-template");
            }

            create(patientId) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let dialog = new SearchTextGloballyDialog(ele, map, rest);
                dialog.init("全文検索");
                dialog.set();
                return dialog;
            }
        }

        (function () {
            let searchTextGloballyDialogFactory = new SearchTextGloballyDialogFactory();
            $("#practice-search-text-globally").on("click", async event => {
                let dialog = searchTextGloballyDialogFactory.create();
                await dialog.open();
            });
        })();

        class ShinryouRegularDialogFactory {
            constructor() {
                this.html = getTemplateHtml("practice-shinryou-regular-dialog-template");
            }

            create(visitId) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let dialog = new ShinryouRegularDialog(ele, map, rest);
                dialog.init(visitId);
                return dialog;
            }
        }

        class PatientInfo {
            constructor(ele, map) {
                this.ele = ele;
                this.map = map;
                this.detail = map.detail;
                map.detailLink.on("click", event => this.toggleDetail());
                this.display = new PatientDisplay(map);
            }

            setPatient(patient) {
                this.display.setPatient(patient);
                if( patient ){
                    this.ele.removeClass("d-none");
                } else {
                    this.ele.addClass("d-none");
                }
            }

            clear() {
                this.display.clear();
            }

            show() {
                this.ele.removeClass("d-none");
            }

            hide() {
                this.ele.addClass("d-none");
            }

            showDetail() {
                this.detail.removeClass("d-none");
            }

            hideDetail() {
                this.detail.addClass("d-none");
            }

            toggleDetail() {
                if (this.detail.hasClass("d-none")) {
                    this.showDetail();
                } else {
                    this.hideDetail();
                }
            }
        }

        let patientInfo = (function () {
            let ele = $("#practice-patient-info");
            let map = parseElement(ele);
            return new PatientInfo(ele, map);
        })();

        practiceState.onPatientIdChanged(async patientId => {
            if (patientId === 0) {
                patientInfo.setPatient(null);
            } else {
                let patient = await rest.getPatient(patientId);
                patientInfo.setPatient(patient);
            }
        });

        class MeisaiDialogFactory {
            constructor() {
                this.html = getTemplateHtml("practice-meisai-dialog-template");
            }

            create(meisai) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let dialog = new MeisaiDialog(ele, map, rest);
                dialog.init(meisai);
                return dialog;
            }
        }

        class SearchTextForPatientDialogFactory {
            constructor() {
                this.html = getTemplateHtml("practice-search-text-dialog-template");
            }

            create(patientId) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let dialog = new SearchTextForPatientDialog(ele, map, rest);
                dialog.init("文章検索");
                dialog.set(patientId);
                return dialog;
            }
        }

        (function () {
            let ele = $("#practice-patient-manip");
            let map = parseElement(ele);
            let meisaiDialogFactory = new MeisaiDialogFactory();
            let searchTextForPatientDialogFactory = new SearchTextForPatientDialogFactory();

            practiceState.onPatientIdChanged(patientId => {
                if (patientId === 0) {
                    ele.addClass("d-none");
                } else {
                    ele.removeClass("d-none");
                }
            });

            map.cashier.on("click", async event => {
                let visitId = practiceState.getVisitId();
                if (visitId <= 0) {
                    alert("現在診察中ではないので、会計はできません。");
                    return;
                }
                let meisai = await rest.getMeisai(visitId);
                let dialog = meisaiDialogFactory.create(meisai);
                let result = await dialog.open();
                if (result) {
                    await practiceState.endExam(visitId, meisai.charge);
                }
            });

            map.end.on("click", async event => {
                let visitId = practiceState.getVisitId();
                if (visitId > 0) {
                    await practiceState.suspendExam(visitId);
                } else if (practiceState.getPatientId() > 0) {
                    practiceState.endPatient();
                }
            });

            map.registerCurrent.on("click", async event => {
                if( practiceState.getVisitId() === 0 && practiceState.getPatientId() > 0 &&
                        confirm("この患者を診察登録しますか？") ){
                    let patientId = practiceState.getPatientId();
                    practiceState.endPatient();
                    let visitId = await rest.startVisit(patientId);
                    await practiceState.startExam(patientId, visitId);
                }
            });

            map.searchText.on("click", async event => {
                let dialog = searchTextForPatientDialogFactory.create(getCurrentPatientId());
                await dialog.open();
            });

            map.refer.on("click", event => {
                console.log("refer");
            });

        })();

        class TitleFactory {
            constructor() {
                this.html = $("template#practice-title-template").html();
                this.rest = rest;
            }

            create(visit) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Title(ele, map, rest);
                comp.init(visit, "current-visit", "temp-visit");
                if (visit.visitId === practiceState.getVisitId()) {
                    comp.markAsCurrent();
                } else if (visit.visitId === practiceState.getTempVisitId()) {
                    comp.markAsTemp();
                }
                return comp;
            }
        }

        class SendFaxFactory {
            constructor() {
                this.html = getTemplateHtml("practice-send-fax-template");
            }

            create(pdfFile, faxNumber) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new SendFax(ele, map, rest);
                comp.init(pdfFile, faxNumber);
                return comp;
            }
        }

        class FaxProgressFactory {
            constructor() {
                this.html = getTemplateHtml("practice-fax-progress-template");
            }

            create(patient, faxNumber, pdfFile, faxSid) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new FaxProgress(ele, map, rest);
                let patientName = patient.lastName + patient.firstName;
                comp.init(patientName, faxNumber, pdfFile, faxSid);
                return comp;
            }
        }

        class TextDispFactory {
            constructor() {
                this.html = getTemplateHtml("practice-text-disp-template");
            }

            create(text) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new TextDisp(ele, map, rest);
                comp.init();
                comp.set(text);
                return comp;
            }
        }

        class TextEnterFactory {
            constructor() {
                this.html = getTemplateHtml("practice-enter-text-template");
            }

            create(visitId) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new TextEnter(ele, map, rest);
                comp.init(visitId);
                return comp;
            }
        }

        class TextFactory {
            constructor() {
                this.html = $("template#practice-text-template").html();
                this.rest = rest;
                this.classToken = "practice-text";
                this.textDispFactory = new TextDispFactory();
                this.textEditFactory = new TextEditFactory();
            }

            create(text) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Text(ele, map, this.rest);
                comp.init(text, this.textDispFactory, this.textEditFactory,
                    this.classToken);
                return comp;
            }

            listTextComponents(wrapperElement) {
                let xs = wrapperElement.find("." + this.classToken);
                let components = [];
                for (let i = 0; i < xs.length; i++) {
                    components.push(xs.slice(i, i + 1).data("component"));
                }
                return components;
            }
        }

        class HokenFactory {
            constructor() {
                this.html = getTemplateHtml("practice-hoken-template");
            }

            create(hokenRep) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let compHoken = new Hoken(ele, map, rest);
                compHoken.init(hokenRep);
                return compHoken;
            }
        }

        class DrugDispFactory {
            constructor() {
                this.html = getTemplateHtml("practice-drug-disp-template");
            }

            create(drugFull) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new DrugDisp(ele, map, rest);
                comp.init(drugFull);
                return comp;
            }
        }

        class ShinryouDispFactory {
            constructor() {
                this.html = getTemplateHtml("practice-shinryou-disp-template");
            }

            create(shinryouFull) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new ShinryouDisp(ele, map, rest);
                comp.init(shinryouFull);
                return comp;
            }
        }

        class ShinryouEditFactory {
            constructor() {
                this.html = getTemplateHtml("practice-shinryou-edit-template");
            }

            create(shinryouFull) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new ShinryouEdit(ele, map, rest);
                comp.init(shinryouFull);
                return comp;
            }
        }

        class ShinryouFactory {
            constructor() {
                this.html = getTemplateHtml("practice-shinryou-template");
                this.shinryouDispFactory = new ShinryouDispFactory();
                this.shinryouEditFactory = new ShinryouEditFactory();
            }

            create(shinryouFull) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Shinryou(ele, map, rest);
                comp.init(shinryouFull, this.shinryouDispFactory, this.shinryouEditFactory);
                return comp;
            }
        }

        class ShohousenPreviewDialogFactory {
            constructor() {
                this.html = getTemplateHtml("practice-shohousen-preview-dialog-template");
                this.drawerSvgModule = DrawerSvg;
            }

            create(ops) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let dialog = new ShohousenPreviewDialog(ele, map, rest);
                dialog.init(ops, this.drawerSvgModule);
                return dialog;
            }
        }

        class TextEditFactory {
            constructor() {
                this.html = getTemplateHtml("practice-edit-text-template");
                this.rest = rest;
                this.currentVisitManager = currentVisitManager;
                this.shohousenPreviewDialogFactory = new ShohousenPreviewDialogFactory();
            }

            create(text) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new TextEdit(ele, map, this.rest);
                comp.init(text, this.currentVisitManager, this.shohousenPreviewDialogFactory);
                return comp;
            }
        }

        class ConductDispFactory {
            constructor() {
                this.html = getTemplateHtml("practice-conduct-disp-template");
            }

            create(conductFull) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new ConductDisp(ele, map, rest);
                comp.init(conductFull);
                return comp;
            }
        }

        class ChargeDispFactory {
            constructor() {
                this.html = getTemplateHtml("practice-charge-disp-template");
            }

            create(charge) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new ChargeDisp(ele, map, rest);
                comp.init(charge);
                return comp;
            }
        }

        class ChargeFactory {
            constructor() {
                this.html = getTemplateHtml("practice-charge-template");
                this.chargeDispFactory = new ChargeDispFactory();
            }

            create(charge) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Charge(ele, map, rest);
                comp.init(charge, this.chargeDispFactory);
                return comp;
            }
        }

        class RecordFactory {
            constructor() {
                this.html = getTemplateHtml("practice-record-template");
                this.wrapper = $("#practice-record-wrapper");
                this.generalWorkarea = $("#practice-general-workarea");
                this.titleFactory = new TitleFactory();
                this.textFactory = new TextFactory();
                this.textEnterFactory = new TextEnterFactory();
                this.hokenFactory = new HokenFactory();
                this.shinryouFactory = new ShinryouFactory();
                this.shinryouRegularDialogFactory = new ShinryouRegularDialogFactory();
                this.conductDispFactory = new ConductDispFactory();
                this.drugDispFactory = new DrugDispFactory();
                this.sendFaxFactory = new SendFaxFactory();
                this.faxProgressFactory = new FaxProgressFactory();
                this.chargeFactory = new ChargeFactory();
                this.currentVisitManager = currentVisitManager;
            }

            create(visitFull, hokenRep) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let record = new Record(ele, map, rest);
                record.init(visitFull, hokenRep, this.titleFactory, this.textFactory,
                    this.hokenFactory, this.shinryouFactory, this.textEnterFactory,
                    this.shinryouRegularDialogFactory, this.conductDispFactory,
                    this.drugDispFactory, this.sendFaxFactory, this.chargeFactory,
                    this.currentVisitManager);
                record.onDelete(async visitId => {
                    await practiceState.deleteVisit(visitId);
                    record.remove();
                });
                record.onTempVisit(visitId =>
                    practiceState.setTempVisitId(visitId));
                record.onClearTempVisit(() => practiceState.setTempVisitId(0));
                record.onFaxSent(async (event, data) => {
                    let patient = await rest.getPatient(visitFull.visit.patientId);
                    let compProgress = this.faxProgressFactory.create(patient, data.faxNumber,
                        data.pdfFile, data.faxSid);
                    compProgress.appendTo(this.generalWorkarea);
                    compProgress.start();
                });
                record.onShinryouCopied((targetVisitId, shinryouFulls) => {
                    let targetRec = findRecord(targetVisitId);
                    if( targetRec ){
                        for(let shinryouFull of shinryouFulls){
                            targetRec.addShinryou(shinryouFull);
                        }
                    }
                });
                return record;
            }
        }

        (function () {
            let map = parseElement($("#practice-select-patient-menu"));
            let patientSearchDialogFactory = new PatientSearchDialogFactory();

            async function clearState() {
                let patientId = practiceState.getPatientId();
                let visitId = practiceState.getVisitId();
                if (patientId > 0 && visitId === 0) {
                    practiceState.endPatient();
                } else if (patientId > 0 && visitId > 0) {
                    await practiceState.suspendExam(visitId);
                } else {
                    practiceState.setTempVisitId(0);
                }
            }

            map.wqueue.on("click", async event => {
                let result = await selectWqueueDialog.open();
                if (result.mode === "selected") {
                    let wqueueFull = result.data;
                    let visitId = wqueueFull.visit.visitId;
                    let patientId = wqueueFull.patient.patientId;
                    await clearState();
                    await practiceState.startExam(patientId, visitId);
                }
            });

            map.search.on("click", async event => {
                let dialog = patientSearchDialogFactory.create();
                let result = await dialog.open();
                console.log("result", result);
                if (result.mode === "enter") {
                    let patientId = result.patient.patientId;
                    await clearState();
                    practiceState.startPatient(patientId);
                } else if (result.mode === "register-enter") {
                    let visitId = result.visitId;
                    let patientId = result.patient.patientId;
                    await clearState();
                    await practiceState.startExam(patientId, visitId);
                }
            });

            map.recent.on("click", async event => {
                let result = await selectRecentVisitDialog.open();
                if (result.mode === "selected") {
                    let patientId = result.data.patient.patientId;
                    await clearState();
                    await practiceState.startPatient(patientId);
                }
            });

            map.today.on("click", async event => {
                let result = await selectTodaysVisitDialog.open();
                if (result.mode === "selected") {
                    let patientId = result.data.patient.patientId;
                    await clearState();
                    await practiceState.startPatient(patientId);
                }
            });

            map.prev.on("click", async event => {
                let result = await selectPreviousVisitDialog.open();
                if (result.mode === "selected") {
                    let patientId = result.data.patient.patientId;
                    await clearState();
                    await practiceState.startPatient(patientId);
                }
            });
        })();

        class DiseaseCurrentFactory {
            constructor() {
                this.html = "<div></div>";
            }

            create(diseaseFulls) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new DiseaseCurrent(ele, map, rest);
                comp.init();
                comp.set(diseaseFulls);
                return comp;
            }
        }

        class DiseaseAddFactory {
            constructor() {
                this.html = getTemplateHtml("practice-disease-add-template");
            }

            create(patientId, date) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new DiseaseAdd(ele, map, rest);
                comp.init();
                comp.set(patientId, date);
                return comp;
            }
        }

        class DiseaseEndFactory {
            constructor() {
                this.html = getTemplateHtml("practice-disease-end-template");
            }

            create(diseaseFulls) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new DiseaseEnd(ele, map, rest);
                comp.init();
                comp.set(diseaseFulls);
                return comp;
            }
        }

        class DiseaseEditFactory {
            constructor() {
                this.html = getTemplateHtml("practice-disease-edit-template");
            }

            create(diseaseFulls) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new DiseaseEdit(ele, map, rest);
                comp.init();
                comp.set(diseaseFulls);
                return comp;
            }
        }

        class DiseaseModifyFactory {
            constructor() {
                this.html = getTemplateHtml("practice-disease-modify-template");
            }

            create(diseaseFull, diseaseExamples) {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new DiseaseModify(ele, map, rest);
                comp.init(diseaseExamples);
                comp.set(diseaseFull);
                return comp;
            }
        }

        let diseaseExamples = await rest.listDiseaseExample();
        initDiseaseExamples(diseaseExamples);

        class DiseaseAreaFactory {
            constructor() {
                this.html = getTemplateHtml("practice-disease-area-template");
                this.diseaseCurrentFactory = new DiseaseCurrentFactory();
                this.diseaseAddFactory = new DiseaseAddFactory();
                this.diseaseEndFactory = new DiseaseEndFactory();
                this.diseaseEditFactory = new DiseaseEditFactory();
                this.diseaseModifyFactory = new DiseaseModifyFactory();
                this.diseaseExamples = diseaseExamples;
            }

            create() {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new DiseaseArea(ele, map, rest);
                comp.init(this.diseaseCurrentFactory, this.diseaseAddFactory, this.diseaseEndFactory,
                    this.diseaseEditFactory, this.diseaseModifyFactory, this.diseaseExamples);
                return comp;
            }
        }

        let diseaseArea = (function () {
            let diseaseAreaFactory = new DiseaseAreaFactory();
            let comp = diseaseAreaFactory.create();
            comp.appendTo($("#practice-disease-wrapper"));
            return comp;
        })();

        practiceState.onPatientIdChanged(async patientId => {
            if( patientId === 0 ){
                diseaseArea.set(0, null);
            } else {
                let cur = await rest.listCurrentDisease(patientId);
                diseaseArea.set(patientId, cur);
                diseaseArea.current();
            }
        });

        let recordFactory = new RecordFactory();

        class NavFactory {
            constructor() {
                this.html = getTemplateHtml("practice-nav-template");
            }

            create() {
                let ele = $(this.html);
                let map = parseElement(ele);
                let comp = new Nav(ele, map, rest);
                comp.init();
                return comp;
            }

        }

        let navs = (function () {
            let navFactory = new NavFactory();
            let result = [
                navFactory.create().appendTo($("#practice-nav-upper")),
                navFactory.create().appendTo($("#practice-nav-lower"))
            ];

            result.forEach(nav => {
                nav.onChange(async (event, page) => {
                    if (page >= 1) {
                        let visitPage = await fetchRecords(practiceState.getPatientId(), page);
                        setRecords(visitPage.visits);
                        setNavs(visitPage.page + 1, visitPage.totalPages);
                    }
                });
            });
            return result;
        })();

        function setNavs(page, total){
            navs.forEach(nav => {
                nav.set(page, total);
                if( total > 1 ){
                    nav.show();
                } else {
                    nav.hide();
                }
            })
        }

        async function getHokenRep(hoken) {
            let hokenRep = await rest.hokenRep(hoken);
            if (hokenRep == "") {
                hokenRep = "［保険なし］"
            }
            return hokenRep;
        }

        function setRecords(visitFulls) {
            let recordWrapperElement = $("#practice-record-wrapper");
            recordWrapperElement.html("");
            for (let visitFull of visitFulls) {
                let record = recordFactory.create(visitFull, visitFull.hokenRep);
                record.onTextCopied((event, copiedText) => {
                    let targetRec = findRecord(copiedText.visitId);
                    if (targetRec) {
                        targetRec.addText(copiedText);
                    }
                });
                record.appendTo(recordWrapperElement);
            }
        }

        async function fetchRecords(patientId, page) {
            if (patientId > 0 && page >= 1) {
                let visitPage = await rest.listVisit(patientId, page - 1);
                visitPage.visits.forEach(async visit => {
                    visit.hokenRep = await getHokenRep(visit.hoken);
                });
                return visitPage;
            } else {
                throw new Error(`Invalid call to fetchRecords: ${patientId}, ${page}`);
            }
        }

        practiceState.onPatientIdChanged(async patientId => {
            if (patientId === 0) {
                setRecords([]);
                setNavs(0, 0);
            } else {
                let visitPage = await fetchRecords(patientId, 1);
                setRecords(visitPage.visits);
                setNavs(visitPage.page + 1, visitPage.totalPages);
            }
        });

        function forEachRecord(f) {
            let xs = $(".practice-record");
            let len = xs.length;
            for (let i = 0; i < len; i++) {
                let x = xs.slice(i, i + 1);
                let c = x.data("component");
                f(c);
            }
        }

        function findRecord(visitId) {
            let xs = $(".practice-record");
            let len = xs.length;
            for (let i = 0; i < len; i++) {
                let x = xs.slice(i, i + 1);
                let c = x.data("component");
                if (c.getVisitId() === visitId) {
                    return c;
                }
            }
            return null;
        }

        practiceState.onTempVisitIdChanged(tempVisitId => {
            forEachRecord(record => {
                if (record.getVisitId() === tempVisitId) {
                    record.markAsTemp();
                } else {
                    record.clearMark();
                }
            });
        });

    })();

</script>