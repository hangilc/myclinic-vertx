<h3>紹介状</h3>

<div>
    <button type="button" class="btn btn-secondary" id="refer-select-patient-button">患者選択</button>
</div>

<div id="refer-current-wrapper" class="mt-3"></div>

<template id="refer-patient-select-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">患者選択</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-search_">
                        <form class="form-inline x-form">
                            <input type="text" class="form-control x-search-text"/>
                            <button type="submit" class="btn btn-secondary ml-2">検索</button>
                        </form>
                        <select size="10" class="x-select form-control mt-2"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary x-enter">選択</button>
                        <button type="button" class="btn btn-secondary x-cancel ml-2">キャンセル</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="refer-current-template" class="mt-3">
    <div>
        <div>
            患者：（<span class="x-patient-id"></span>）<span class="x-name"></span>
        </div>
        <div>
            <textarea class="form-control mt-2 x-content" rows="16"></textarea>
        </div>
    </div>
</template>

<script>

    async function initRefer(){
        let {PatientSelectDialog} = await import("./refer/patient-select-dialog.js");
        let {parseElement} = await import("./js/parse-element.js");
        let {Current} = await import("./refer/current.js");

        let currentPatient = null;

        class PatientSearchDialogFactory {
            create(){
                let html = $("#refer-patient-select-dialog-template").html();
                let ele = $(html);
                let map = parseElement(ele);
                let dialog = new PatientSelectDialog(ele, map, rest);
                dialog.init();
                dialog.set();
                return dialog;
            }
        }

        let patientSelectDialogFactory = new PatientSearchDialogFactory();

        class CurrentFactory {
            create(patient){
                let html = $("#refer-current-template").html();
                let ele = $(html);
                let map = parseElement(ele);
                let comp = new Current(ele, map, rest);
                comp.init();
                comp.set(patient);
                return comp;
            }
        }

        let currentFactory = new CurrentFactory();

        $("#refer-select-patient-button").on("click", async event => {
            let dialog = patientSelectDialogFactory.create();
            let result = await dialog.open();
            if( result ){
                currentPatient = result;
                let current = currentFactory.create(currentPatient);
                current.prependTo($("#refer-current-wrapper"));
            }
        });
    }

</script>