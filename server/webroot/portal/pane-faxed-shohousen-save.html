<form>
    <div class="form-inline">
        <span>開始日</span>
        <input type="date" class="form-control ml-1" id="faxed-from-date-input"/>
        <span class="ml-2">終了日</span>
        <input type="date" class="form-control ml-1" id="faxed-upto-date-input"/>
    </div>
    <div class="form-inline mt-2">
        <button type="button" class="btn btn-primary form-control" id="faxed-create-button">データ作成</button>
    </div>
</form>

<div id="faxed-no-pharma-error" class="faxed-creation-error d-none">
    <div class="alert alert-danger mt-3">
        <h5>薬局を見つけられません</h5>
    </div>
    <div id="faxed-no-pharma-patient"></div>
    <div id="faxed-no-pharma-visited-at"></div>
    <div id="faxed-no-pharma-texts"></div>
</div>

<div id="faxed-other-creation-error" class="faxed-creation-error d-none">
    <div class="alert alert-danger mt-3">
        <h5>処方箋データの作成に失敗しました</h5>
    </div>
    <pre id="faxed-other-creation-error-cause"></pre>
</div>

<div id="faxed-progress" class="d-none"></div>

<div id="faxed-data-file-status" class="faxed-group-status"></div>
<div id="faxed-shohousen-text-status" class="faxed-group-status"></div>
<div id="faxed-shohousen-pdf-status" class="faxed-group-status"></div>
<div id="faxed-pharma-letter-text-status" class="faxed-group-status"></div>
<div id="faxed-pharma-letter-pdf-status" class="faxed-group-status"></div>
<div id="faxed-pharma-label-pdf-status" class="faxed-group-status"></div>
<div id="faxed-clinic-label-pdf-status" class="faxed-group-status"></div>

<ul class="nav nav-tabs mt-3">
    <li class="nav-item">
        <a class="nav-link active" href="javascript:void(0)">処理済一覧</a>
    </li>
</ul>
<div id="faxed-nav-content"></div>

<template id="tmpl-text">
    <div></div>
</template>

<template id="tmpl-textex">
    <div>
        <div part="content"></div>
        <div part="commands">
            <button part="command-edit">編集</button>
        </div>
    </div>
</template>

<template id="tmpl-textform">
    <div>
        <textarea></textarea>
        <div part="commands">
            <button part="enter">入力</button>
            <button part="cancel">キャンセル</button>
        </div>
    </div>
</template>

<script>
    function compText(content) {
        let e = $($("#tmpl-text").html());
        e.html(content.replace(/\n/g, "<br/>"));
        return {
            ele: e
        };
    }

    function compTextForm(text) {
        let e = $($("#tmpl-textform").html());
        let $textarea = e.find("textarea");
        $textarea.html(text.content);
        let comp = {
            ele: e,
            $textarea: $textarea,
            $commands: e.find("[part=enter]"),
            $enter: e.find("[part=enter]"),
            $cancel: e.find("[part=cancel]"),
            onEnter: () => {
            },
            onCanel: () => {
            }
        };
        comp.$enter.on("click", event => {
            comp.onEnter(comp.$textarea.val());
        })
        comp.$cancel.on("click", event => {
            comp.onCancel();
        });
        return comp;
    }

    function compTextEx(text) {
        let e = $($("#tmpl-textex").html());
        let $content = e.find("[part=content]").html(text.content.replace(/\n/g, "<br/>"));
        let $editButton = e.find("[part=command-edit]");
        let comp = {
            ele: e,
            $content: $content,
            $commandBox: e.find("[part=commands]"),
            $editButton: $editButton,
            onFormCreated: form => {
            },
            onFormEnter: (content, form) => {
            }
        }
        $editButton.on("click", event => {
            let form = compTextForm(text);
            comp.onFormCreated(form);
            replaceElement(e, form.ele);
            form.onEnter = content => comp.onFormEnter(content, form);
            form.onCancel = () => {
                replaceElement(form.ele, e);
            };
        });
        return comp;
    }

    (function () {

        function shohousenUrl(path) {
            return "../integration/faxed-shohousen-data/" + path;
        }

        function getLastGroup() {
            return ajaxGet(shohousenUrl("get-last-group"));
        }

        function getPrevGroups() {
            return ajaxGet(shohousenUrl("list-groups"));
        }

        async function doSubmenuPrevGroups() {
            let prevGroups = await getPrevGroups();
            let ul = $("<ul>");
            if (prevGroups) {
                prevGroups.forEach(group => {
                    let li = $("<li>").text(group);
                    ul.append(li);
                });
            }
            $("#faxed-nav-content").html("").append(ul);
        }

        function offerNextGroupDates(prevUpto){
            let momentLast = moment(prevUpto);
            let momentStart = momentLast.add(1, "day");
            let momentEnd = momentStart.clone();
            if (momentStart.date() < 15) {
                momentEnd.date(15);
            } else {
                momentEnd = momentEnd.endOf("month");
            }
            return [momentStart.format("YYYY-MM-DD"), momentEnd.format("YYYY-MM-DD")];
        }

        async function setup() {
            $(".faxed-group-status").html("");
            let lastGroup = await getLastGroup();
            let nextGroup;
            if (lastGroup && !lastGroup.completed) {
                nextGroup = lastGroup;
            } else {
                nextGroup = {};
                if( lastGroup ){
                    [nextGroup.from, nextGroup.upto] = offerNextGroupDates(lastGroup.upto);
                }
            }
            $("#faxed-from-date-input").val(nextGroup.from);
            $("#faxed-upto-date-input").val(nextGroup.upto);
            $("#faxed-data-file-status").html("データ：" +
                (nextGroup.data_done ? "作成済" : "未作成"));
            $("#faxed-shohousen-text-status").html("処方箋テキスト：" +
                (nextGroup.shohousen_text_done ? "作成済" : "未作成"));
            $("#faxed-shohousen-pdf-status").html("処方箋ＰＤＦ：" +
                (nextGroup.shohousen_pdf_done ? "作成済" : "未作成"));
            $("#faxed-pharma-letter-text-status").html("薬局レターテキスト" +
                (nextGroup.pharma_letter_text_done ? "作成済" : "未作成"));
            $("#faxed-pharma-letter-pdf-status").html("薬局レターＰＤＦ：" +
                (nextGroup.pharma_letter_pdf_done ? "作成済" : "未作成"));
            $("#faxed-pharma-label-pdf-status").html("薬局ラベルＰＤＦ：" +
                (nextGroup.pharma_label_pdf_done ? "作成済" : "未作成"));
            $("#faxed-clinic-label-pdf-status").html("クリニックラベルＰＤＦ：" +
                (nextGroup.clinic_label_pdf_done ? "作成済" : "未作成"));
        }

        function createTextComponent(text) {
            let c = compTextEx(text);
            let e = c.ele;
            e.addClass("border border-secondary rounded my-2 p-2");
            c.$commandBox.addClass("mt-2");
            c.onFormCreated = form => {
                form.ele.addClass("form-group border border-warning rounded p-2");
                form.$textarea.addClass("form-control").attr("rows", "7");
                form.$commands.addClass("mt-2");
            };
            c.onFormEnter = async (content, form) => {
                let newText = $.extend({}, text);
                newText.content = content;
                await ajaxPost("../json/update-text", newText);
                let updatedText = await ajaxGet("../json/get-text", {"text-id": text.textId});
                let newElement = createTextComponent(updatedText);
                replaceElement(form.ele, newElement.ele);
            };
            return c;
        }

        function showNoPharma(patient, visit, texts) {
            let name = patient.lastName + patient.firstName;
            let visitedAt = moment(visit.visitedAt);
            $("#faxed-no-pharma-patient").text("患者：" + name);
            $("#faxed-no-pharma-visited-at").text("診察日：" + visitedAt.format("YYYY-MM-DD"));
            let textWrapper = $("#faxed-no-pharma-texts").html("");
            texts.forEach(text => {
                let c = createTextComponent(text);
                textWrapper.append(c.ele);
            });
            $("#faxed-no-pharma-error").removeClass("d-none");
        }

        function showOtherCreationError(message) {
            $("#faxed-other-creation-error-cause").html(message);
            $("#faxed-other-creation-error").removeClass("d-none");
        }

        function getFromDate() {
            return $("#faxed-from-date-input").val();
        }

        function getUptoDate() {
            return $("#faxed-upto-date-input").val();
        }

        async function saveShohousenData(content) {
            let from = getFromDate().replace(/-/g, "");
            let upto = getUptoDate().replace(/-/g, "");
            let url = `../integration/faxed-shohousen-data/save-data?from=${from}&upto=${upto}`;
            let path = await ajaxPost(url, content, false);
            let report = `処方箋データを保存しました。${path}`;
            let ele = $("<div>").text(report).addClass("my-2");
            $("#faxed-progress").removeClass("d-none").append(ele);
        }

        $("#faxed-create-button").on("click", async event => {
            let data = {
                from: $("#faxed-from-date-input").val(),
                upto: $("#faxed-upto-date-input").val()
            };
            let result = await ajaxGet("../integration/faxed-shohousen-data/create-data", data);
            $(".faxed-creation-error").addClass("d-none");
            $("#faxed-progress").html("").addClass("d-none");
            if (result.stderr) {
                let reWithoutPharma = /presc without pharma\s+<Visit\(visit_id='(\d+)'/;
                let match = reWithoutPharma.exec(result.stderr);
                if (match) {
                    let visitId = match[1];
                    let visit = await ajaxGet("../json/get-visit", {"visit-id": visitId});
                    let patient = await ajaxGet("../json/get-patient", {"patient-id": visit.patientId});
                    let texts = await ajaxGet("../json/list-text", {"visit-id": visitId});
                    showNoPharma(patient, visit, texts);
                } else {
                    showOtherCreationError(result.stderr);
                }
            } else {
                await saveShohousenData(result.stdout);
            }
        });

        setup();
        doSubmenuPrevGroups();

    })();
</script>


