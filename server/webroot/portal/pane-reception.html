<h3>受付</h3>

<div id="reception-main-commands">
    <button type="button" class="btn btn-secondary x-new-patient">新規患者</button>
    <button type="button" class="btn btn-secondary x-search-patient ml-2">患者検索</button>
    <button type="button" class="btn btn-link x-search-payment ml-2">会計検索</button>
    <button type="button" class="btn btn-link x-search-receipt-paper ml-2">領収書用紙</button>
</div>

<div id="reception-commands-second-row">
    <div class="form-inline mt-2">
        患者番号：<input type="text" class="form-control"/>
        <button class="btn btn-secondary ml-2">診療受付</button>
        <button class="btn btn-secondary ml-2">患者情報</button>
    </div>
</div>

<div id="reception-workarea" class="my-3"></div>

<table class="table mt-3" id="reception-wqueue-table">
    <thead>
    <tr>
        <th scope="col">状態</th>
        <th scope="col">ID</th>
        <th scope="col">氏名</th>
        <th scope="col">よみ</th>
        <th scope="col">性別</th>
        <th scope="col">生年月日</th>
        <th scope="col">年齢</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>診待</td>
        <th scope="row">123</th>
        <td>診療 太郎</td>
        <td>しんりょう たろう</td>
        <td>男</td>
        <td>昭和12年1月2日</td>
        <td>72才</td>
    </tr>
    <tr class="table-active">
        <td>診待</td>
        <th scope="row">123</th>
        <td>診療 太郎</td>
        <td>しんりょう たろう</td>
        <td>男</td>
        <td>昭和12年1月2日</td>
        <td>72才</td>
    </tr>
    <tr>
        <td>診待</td>
        <th scope="row">123</th>
        <td>診療 太郎</td>
        <td>しんりょう たろう</td>
        <td>男</td>
        <td>昭和12年1月2日</td>
        <td>72才</td>
    </tr>
    <tr>
        <td>診待</td>
        <th scope="row">123</th>
        <td>診療 太郎</td>
        <td>しんりょう たろう</td>
        <td>男</td>
        <td>昭和12年1月2日</td>
        <td>72才</td>
    </tr>
    </tbody>
</table>

<div id="reception-bottom-commands" class="form-inline">
    <button type="button" class="btn btn-secondary x-refresh">更新</button>
    <button type="button" class="btn btn-secondary ml-2 x-cashier">会計</button>
    <button type="button" class="btn btn-link ml-2 x-deselection">選択解除</button>
    <button type="button" class="btn btn-link ml-2 x-delete">削除</button>
</div>

<template id="reception-patient-search-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">患者検索</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-search_">
                        <form class="form-inline x-form">
                            <input type="text" class="form-control x-search-text"/>
                            <button type="submit" class="btn btn-secondary ml-2">検索</button>
                            <button type="submit" class="btn btn-secondary ml-2 x-recent">最近の登録</button>
                        </form>
                        <select size="10" class="x-select form-control mt-2"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row x-disp_">
                                <div class="col-sm-4 text-right">患者番号：</div>
                                <div class="col-sm-8 x-patient-id"></div>
                                <div class="col-sm-4 text-right">氏名：</div>
                                <div class="col-sm-8">
                                    <span class="x-last-name"></span>
                                    <span class="x-first-name"></span>
                                </div>
                                <div class="col-sm-4 text-right">よみ：</div>
                                <div class="col-sm-8">
                                    <span class="x-last-name-yomi"></span>
                                    <span class="x-first-name-yomi"></span>
                                </div>
                                <div class="col-sm-4 text-right">生年月日：</div>
                                <div class="col-sm-8 x-birthday"></div>
                                <div class="col-sm-4 text-right">性別：</div>
                                <div class="col-sm-8 x-sex"></div>
                                <div class="col-sm-4 text-right">住所：</div>
                                <div class="col-sm-8 x-address"></div>
                                <div class="col-sm-4 text-right">電話番号：</div>
                                <div class="col-sm-8 x-phone"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-secondary btn-block x-edit"
                            >編集
                            </button>
                            <button type="button" class="btn btn-secondary x-register btn-block"
                            >診療受付
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</template>

<template id="reception-patient-and-hoken-edit-widget-template">
    <div class="mb-3 border border-secondary rounded p-3">
        <div class="d-flex p-2" style="background-color: #ccc;">
            <div class="font-weight-bold flex-grow-1">患者情報編集</div>
            <div><span class="font-weight-bold x-widget-close"
                       style="cursor: pointer;">&times;</span></div>
        </div>
        <div class="mt-2 row">
            <div class="col-md-4">
                <div class="row x-disp_">
                    <div class="col-sm-4">患者番号：</div>
                    <div class="col-sm-8 x-patient-id"></div>
                    <div class="col-sm-4">氏名：</div>
                    <div class="col-sm-8">
                        <span class="x-last-name"></span>
                        <span class="x-first-name"></span>
                    </div>
                    <div class="col-sm-4">よみ：</div>
                    <div class="col-sm-8">
                        <span class="x-last-name-yomi"></span>
                        <span class="x-first-name-yomi"></span>
                    </div>
                    <div class="col-sm-4">生年月日：</div>
                    <div class="col-sm-8 x-birthday"></div>
                    <div class="col-sm-4">性別：</div>
                    <div class="col-sm-8 x-sex"></div>
                    <div class="col-sm-4">住所：</div>
                    <div class="col-sm-8 x-address"></div>
                    <div class="col-sm-4">電話番号：</div>
                    <div class="col-sm-8 x-phone"></div>
                </div>
                <div class="mt-2">
                    <button type="button" class="x-edit-basic btn btn-secondary">編集</button>
                </div>
            </div>
            <div class="col-md-8">
                <div>
                    <table class="table x-hoken-list">
                        <thead>
                        <tr>
                            <th>種別</th>
                            <th>期限開始</th>
                            <th>期限終了</th>
                            <th>本人・家族</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <input type="checkbox" class="x-current-only" checked> 現在有効のみ
                </div>
                <div class="mt-2">
                    <button class="btn btn-secondary">新規社保国保</button>
                    <button class="ml-2 btn btn-secondary">新規後期高齢</button>
                    <button class="ml-2 btn btn-secondary">新規公費負担</button>
                </div>
            </div>
        </div>
        <div class="mt-2 d-flex justify-content-end">
            <button type="button" class="x-close btn btn-secondary">閉じる</button>
            <button type="button" class="x-register btn btn-secondary ml-2">診療受付</button>
        </div>
        <div class="x-workarea ml-3"></div>
    </div>
</template>

<template id="reception-patient-edit-widget-template">
    <div class="x-form_">
        <div class="row">
            <div class="col-sm-2 d-flex justify-content-end">患者番号</div>
            <div class="x-patient-id col-md-10"></div>
        </div>

        <div class="row mt-2">
            <div class="col-sm-2 d-flex justify-content-end">氏名</div>
            <div class="col-sm-10 form-inline">
                <input type="text" class="x-last-name form-control"/>
                <input type="text" class="x-first-name form-control ml-2"/>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-sm-2 d-flex justify-content-end mt-2">よみ</div>
            <div class="col-sm-10 form-inline">
                <input type="text" class="x-last-name-yomi form-control"/>
                <input type="text" class="x-first-name-yomi form-control ml-2"/>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-sm-2 d-flex justify-content-end mt-2">生年月日</div>
            <div class="col-sm-10 form-inline x-birthday_">
                <select class="x-gengou form-control">
                    <option>令和</option>
                    <option>平成</option>
                    <option selected>昭和</option>
                    <option>大正</option>
                    <option>明治</option>
                </select>
                <input type="text" class="x-nen form-control ml-2" size="3"/> 年
                <input type="text" class="x-month form-control ml-2" size="3"/> 月
                <input type="text" class="x-day form-control ml-2" size="3"/> 日
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-sm-2 d-flex justify-content-end mt-2">性別</div>
            <div class="col-sm-10">
                <form class="form-inline x-sex" onsubmit="return false">
                    <input type="radio" name="sex" value="M"> 男
                    <input type="radio" name="sex" value="F" checked class="ml-2"> 女
                </form>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-sm-2 d-flex justify-content-end mt-2">住所</div>
            <div class="col-sm-10 form-inline">
                <input type="text" class="x-address form-control" size="50"/>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-sm-2 d-flex justify-content-end mt-2">電話番号</div>
            <div class="col-sm-10 form-inline">
                <input type="text" class="x-phone form-control"/>
            </div>

        </div>
    </div>
</template>

<template id="reception-date-input-template">
    <div class="form-inline">
        <select class="x-gengou form-control">
            <option>令和</option>
            <option>平成</option>
            <option>昭和</option>
            <option>大正</option>
            <option>明治</option>
        </select>
        <input type="number" class="x-nen form-control ml-2" size="3"/> 年
        <input type="number" class="x-month form-control ml-2" size="3"/> 月
        <input type="number" class="x-day form-control ml-2" size="3"/> 日
    </div>
</template>

<script>

    (async function () {
        let {parseElement} = await import("./js/parse-element.js");
        let {PatientSearchDialog} = await import("./reception/patient-search-dialog.js");
        let {PatientAndHokenEditWidget} = await import("./reception/patient-and-hoken-edit-widget.js");
        let {PatientEditWidget} = await import("./reception/patient-edit-widget.js");
        let {HokenHelper} = await import("./reception/hoken-helper.js");
        let {DateInput} = await import("./reception/date-input.js");

        let receptionWorkarea = $("#reception-workarea");

        class DateInputFactory {
            create(date){
                let html = $("template#reception-date-input-template").html();
                let ele = $(html);
                let map = parseElement(ele);
                let comp = new DateInput(ele, map, rest);
                comp.init();
                comp.set(date);
                return comp;
            }
        }

        class PatientAndHokenWidgetFactory {
            create(patient, currentHokenList, patientEditWidgetFactory) {
                let html = $("template#reception-patient-and-hoken-edit-widget-template").html();
                let ele = $(html);
                let map = parseElement(ele);
                let widget = new PatientAndHokenEditWidget(ele, map, rest);
                widget.init(patientEditWidgetFactory);
                widget.set(patient, currentHokenList);
                return widget;
            }
        }

        class PatientEditWidgetFactory {
            create(patient) {
                let html = $("template#reception-patient-edit-widget-template").html();
                let ele = $(html);
                let map = parseElement(ele);
                let widget = new PatientEditWidget(ele, map, rest);
                widget.init();
                widget.set(patient);
                return widget;
            }
        }

        (function () {
            let ele = $("#reception-main-commands");
            let map = parseElement(ele);
            let hokenHelper = new HokenHelper(rest);
            let patientAndHokenWidgetFactory = new PatientAndHokenWidgetFactory();
            let patientEditWidgetFactory = new PatientEditWidgetFactory();
            let dateInputFactory = new DateInputFactory();

            map.newPatient.on("click", event => {
                alert("new patient: not supported");
            });

            map.searchPatient.on("click", async event => {
                let html = $("template#reception-patient-search-dialog-template").html();
                let ele = $(html);
                let map = parseElement(ele);
                let dialog = new PatientSearchDialog(ele, map, rest);
                dialog.init();
                dialog.set();
                let result = await dialog.open();
                if (result && result.action === "edit") {
                    let patient = result.patient;
                    let hokenList = await hokenHelper.fetchAvailableHoken(patient.patientId,
                        kanjidate.todayAsSqldate());
                    let editWidget = patientAndHokenWidgetFactory.create(patient, hokenList,
                        patientEditWidgetFactory);
                    editWidget.prependTo(receptionWorkarea);
                }
            });
        })();
    })();
</script>