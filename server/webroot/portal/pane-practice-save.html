<!--suppress ALL -->
<div class="row">
    <h3 class="col-sm-2">診察</h3>
    <div class="col-sm-10">
        <button class="btn btn-secondary practice-choose-patient-button">患者選択</button>
    </div>
</div>

<div id="practice-patient-info" class="d-none mx-2">
    <span class="x-patient-id"></span>
    <span class="x-last-name"></span><span class="x-first-name"></span>
    <span class="x-last-name-yomi"></span><span class="x-first-name-yomi"></span>
    <span class="x-birthday"></span>
    <span class="x-age"></span>
    <span class="x-sex"></span>
    <button type="button" class="x-detail-link btn btn-link">詳細</button>
    <div class="x-detail d-none row">
        <div class="col-sm-3">住所</div>
        <div class="x-address col-sm-9"></div>
        <div class="col-sm-3">電話番号</div>
        <div class="x-phone col-sm-9"></div>
        </v>
    </div>
</div>

<div id="practice-record-area"></div>

<template id="practice-choose-patient-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">患者選択</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-search">
                        <form class="form-inline x-form">
                            <input class="form-control x-input"/>
                            <button type="submit" class="form-control ml-2">検索</button>
                        </form>
                        <select class="form-control mt-2 form-control x-select" size="5"></select>
                    </div>
                    <div class="card mt-2">
                        <div class="card-body">
                            <div class="row x-display">
                                <div class="col-sm-3">患者番号</div>
                                <div class="col-sm-9 x-patient-id"></div>
                                <div class="col-sm-3">氏名</div>
                                <div class="col-sm-9">
                                    <span class="x-last-name"></span><span
                                        class="x-first-name"></span>
                                </div>
                                <div class="col-sm-3">よみ</div>
                                <div class="col-sm-9 x-yomi">
                                    <span class="x-last-name-yomi"></span><span
                                        class="x-first-name-yomi"></span>
                                </div>
                                <div class="col-sm-3">生年月日</div>
                                <div class="col-sm-9">
                                    <span class="x-birthday"></span>
                                    <span class="x-age"></span>
                                </div>
                                <div class="col-sm-3">性別</div>
                                <div class="col-sm-9 x-sex"></div>
                                <div class="col-sm-3">住所</div>
                                <div class="col-sm-9 x-address"></div>
                                <div class="col-sm-3">電話</div>
                                <div class="col-sm-9 x-phone"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary x-register-enter">受付・選択</button>
                    <button type="button" class="btn btn-primary x-enter">選択</button>
                    <button type="button" class="btn btn-secondary x-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="practice-record-template">
    <div>
        <div class="x-title"></div>
        <div class="row">
            <div class="x-left col-sm-6 rp-1">
                <div class="x-text-wrapper"></div>
                <div class="x-command-wrapper">
                    <button type="button" class="btn btn-link x-enter-text">[文章入力]</button>
                </div>
            </div>
            <div class="x-right col-sm-6 lp-1"></div>
        </div>
    </div>
</template>

<template id="practice-enter-text-template">
    <div class="mt-2">
        <textarea class="form-control x-textarea" rows="6"></textarea>
        <div class="form-inline">
            <button type="button" class="btn btn-link x-enter">入力</button>
            <button type="button" class="btn btn-link x-cancel">キャンセル</button>
        </div>
    </div>
</template>

<template id="practice-title-template">
    <div class="mt-2"></div>
</template>

<template id="practice-text-template">
    <div class="my-1"></div>
</template>

<script>
    function hyphenToCamel(s) {
        let ps = s.split(/-+/);
        for (let i = 1; i < ps.length; i++) {
            let p = ps[i];
            ps[i] = p[0].toUpperCase() + p.substring(1);
        }
        return ps.join("");
    }

    function parseElement(ele) {
        ele = $(ele);
        if (ele.length === 1) {
            let attrClass = ele.attr("class");
            if (attrClass) {
                for (let cls of attrClass.split(/\s+/)) {
                    if (cls.startsWith("x-")) {
                        let name = cls.substring(2);
                        ele.removeClass(cls);
                        let m = {};
                        name = hyphenToCamel(name);
                        m[name] = ele;
                        let sub = parseElement(ele.children());
                        if (Object.keys(sub).length > 0) {
                            m[name + "_"] = sub;
                        }
                        return m;
                    }
                }
            }
            return parseElement(ele.children());
        } else {
            let map = {};
            for (let e of ele.toArray()) {
                Object.assign(map, parseElement(e));
            }
            return map;
        }
    }

    function parseTemplate(templateId) {
        let ele = $($("template#" + templateId).html());
        return parseElement(ele);
    }

    function flatten(map) {
        let result = {};
        for (let key of Object.keys(map)) {
            if (key.endsWith("_")) {
                Object.assign(result, flatten(map[key]));
            } else {
                result[key] = map[key];
            }
        }
        return result;
    }

    function replaceElement(prevElement, newElement) {
        prevElement.after(newElement);
        prevElement.detach();
    }

    (async function () {
        let ChoosePatientDialog = (await import("./practice/choose-patient-dialog.js")).ChoosePatientDialog;
        let PatientDisplay = (await import("./practice/patient-display.js")).PatientDisplay;

        let choosePatientButtonElement = $(".practice-choose-patient-button");

        choosePatientButtonElement.on("click", async event => {
            let map = parseTemplate("practice-choose-patient-dialog-template");
            let props = {
                dialog: map.dialog,
                registerEnter: map.dialog_.registerEnter,
                enter: map.dialog_.enter,
                cancel: map.dialog_.cancel,
                search: flatten(map.dialog_.search_),
                display: flatten(map.dialog_.display_),
                displayOpts: {
                    formatter: {
                        birthday: data => data.kanji + "生",
                        sex: data => data.kanji + "性",
                        age: age => `（${age}才）`
                    }
                }
            }
            let dialog = new ChoosePatientDialog(props, rest);
            let result = await dialog.open();
            if (result.mode !== "cancel") {
                let patient = result.patient;
                $("body").trigger("patientChanged", patient);
                let visits = await rest.listVisit(patient.patientId, 0);
                $("body").trigger("visitsChanged", visits);
            }
        });

        class PatientInfo {
            constructor(ele) {
                this.ele = ele;
                let map = parseElement(ele);
                this.detail = map.detail;
                map.detailLink.on("click", event => this.toggleDetail());
                this.display = new PatientDisplay(flatten(map), {
                    formatter: {
                        patientId: patientId => `[${patientId}]`,
                        lastNameYomi: value => `（${value}`,
                        firstNameYomi: value => `${value}）`,
                        birthday: data => `${data.kanji}生`,
                        age: value => `（${value}才）`,
                        sex: data => `${data.kanji}性`
                    }
                });
            }

            setPatient(patient) {
                this.display.setPatient(patient);
            }

            show() {
                this.ele.removeClass("d-none");
            }

            hide() {
                this.ele.addClass("d-none");
            }

            showDetail() {
                this.detail.removeClass("d-none");
            }

            hideDetail() {
                this.detail.addClass("d-none");
            }

            toggleDetail() {
                if (this.detail.hasClass("d-none")) {
                    this.showDetail();
                } else {
                    this.hideDetail();
                }
            }
        }

        let patientInfo = new PatientInfo($("#practice-patient-info"));

        $("body").on("patientChanged", (event, patient) => {
            if (patient) {
                patientInfo.setPatient(patient);
                patientInfo.hideDetail();
                patientInfo.show();
            } else {

            }
        });

        class RecordSave {
            constructor(ele, rest, visitFull, enterTextFactory, textFactory) {
                this.ele = ele;
                this.visitFull = visitFull;
                this.rest = rest;
                this.enterTextFactory = enterTextFactory;
                this.textFactory = textFactory;
                this.visit = visitFull.visit;
                let map = flatten(parseElement(this.ele));
                map.title.text(this.titleRep(visitFull.visit.visitedAt));

                map.enterText.on("click", event => {
                    let enterText = this.enterTextFactory.create(this.rest, this.visit.visitId);
                    enterText.onEntered((event, text) => {
                        enterText.remove();
                    });
                    enterText.onCancel(event => {
                        enterText.remove();
                    });
                    map.enterText.before(enterText.ele);
                });
            }

            titleRep(sqldatetime){
                let data = kanjidate.sqldatetimeToData(sqldatetime);
                let nen = (data.nen + "").padStart(2, "0");
                let month = (data.month + "").padStart(2, "0");
                let day = (data.day + "").padStart(2, "0");
                let hour = (data.hour + "").padStart(2, "0");
                let minute = (data.minute + "").padStart(2, "0");
                let rep = `${data.gengou.name}${nen}年${month}月${day}日（${data.youbi}） ${hour}時${minute}分`;
                return rep;
            }
        }

        class Record {
            constructor(ele, map, visitFull, titleFactory){
                this.ele = ele;
                this.titleElement = map.title;
                this.leftElement = map.left;
                this.rightElement = map.right;
                this.visitFull = visitFull;
                this.visit = visitFull.visit;
                this.titleFactory = titleFactory;
                this.title = titleFactory.create(this.visit);
                this.title.appendTo(this.titleElement);
            }

            appendTo(element){
                element.append(this.ele);
            }
        }

        class RecordFactory {
            constructor(){
                this.html = $("template#practice-record-template").html();
            }

            create(visitFull){
                let ele = $(this.html);
                let map = flatten(parseElement(ele));
                return new Record(ele, map, visitFull, new TitleFactory());
            }
        }

        class Title {
            constructor(ele, map, visit){
                this.ele = ele;
                this.ele.text(this.rep(visit.visitedAt));
            }

            rep(sqldatetime){
                let data = kanjidate.sqldatetimeToData(sqldatetime);
                let nen = (data.nen + "").padStart(2, "0");
                let month = (data.month + "").padStart(2, "0");
                let day = (data.day + "").padStart(2, "0");
                let hour = (data.hour + "").padStart(2, "0");
                let minute = (data.minute + "").padStart(2, "0");
                return `${data.gengou.name}${nen}年${month}月${day}日（${data.youbi}） ${hour}時${minute}分`;
            }

            appendTo(element){
                element.append(this.ele);
            }
        }

        class TitleFactory {
            constructor(){
                this.html = $("template#practice-title-template").html();
            }

            create(visit){
                let ele = $(this.html);
                let map = flatten(parseElement(ele));
                return new Title(ele, map, visit);
            }
        }

        class Text {
            constructor(ele, map, rest, text){
                this.ele = ele;
                this.rest = rest;
                this.text = text;
                this.ele.html(text.content.replace(/\r\n|\n|\r/g, "<br/>\n"));
            }

            appendTo(element){
                element.append(this.ele);
            }
        }

        class TextFactory {
            constructor(html, rest){
                this.rest = rest;
            }

            create(text){
                let ele = $(this.html);
                let map = flatten(ele);
                return new Text(ele, map, this.rest, text);
            }
        }

        class EnterText {
            constructor(ele, map, rest, visitId){
                this.ele = ele;
                this.textAreaElement = map.textarea;
                this.enterElement = map.enter;
                this.cancelElement = map.cancel;
                this.rest = rest;
                this.visitId = visitId;
                this.cancelElement.on("click", event => {
                    ele.trigger("cancel");
                });
                this.enterElement.on("click", event => this.doEnter());
            }

            async doEnter(){
                let content = this.textAreaElement.val();
                let text = {
                    content: content,
                    visitId: this.visitId
                };
                let textId = await rest.enterText(text);
                let entered = await rest.getText(textId);
                this.ele.trigger("onEntered", entered);
            }

            onEntered(cb){
                this.ele.on("onEntered", cb);
            }

            onCancel(cb){
                this.ele.on("cancel", cb);
            }

            remove(){
                this.ele.remove();
            }
        }

        class EnterTextFactory {
            constructor(html, rest){
                this.html = html;
                this.rest = rest;
            }

            create(visitId){
                let ele = $(this.html);
                this.map = flatten(parseElement(ele));
                return new EnterText(ele, map, this.rest, visitId);
            }
        }

        $("body").on("visitsChanged", (event, page) => {
            let wrapper = $("#practice-record-area");
            wrapper.html("");
            let recordFactory = new RecordFactory();
            for(let visitFull of page.visits){
                let rec = recordFactory.create(visitFull);
                rec.appendTo(wrapper);
            }
        });


    })();
</script>
