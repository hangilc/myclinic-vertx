<div id="houmon-kango-wrapper" class="pane"></div>

<script>

    async function initHoumonKango(){
        let {HoumonKango} = await import("./houmon-kango/houmon-kango.js");

        let clinicInfo = await rest.getClinicInfo();

        function init(){
            let comp = new HoumonKango(rest, integration, clinicInfo);
            comp.onEndPatient(() => init());
            comp.prependTo($("#houmon-kango-wrapper").html(""));
        }

        init();
    }

    async function initHoumonKango_save() {
        let chooser = await import("./js/choose-patient.js");
        let displayer = await import("./js/disp-patient.js");
        let {Data} = await import("./houmon-kango/data.js");

        let clinicParam = await integration.getHoumonKangoClinicParam();

        let theRecord;

        function initRecord(patientId) {
            theRecord = {
                patientId: patientId,
                history: []
            };
        }

        initRecord(0);

        function resetRecord(){
            theRecord.patientId = 0;
            theRecord.history = [];
        }

        $("#houmon-kango-leader").on("reset", event => resetRecord());

        function setRecord(record) {
            theRecord = record;
        }

        function addToRecordHistory(data) {
            theRecord.history.push({
                stamp: getTimeStamp(),
                data: data
            });
        }

        function getRecordHistory() {
            return theRecord.history;
        }

        function removeFromRecordHistory(stamp) {
            theRecord.history = theRecord.history.filter(rec => rec.stamp !== stamp);
        }

        async function saveRecord() {
            await integration.saveHoumonKangoRecord(theRecord);
            return await integration.getHoumonKangoRecord(theRecord.patientId);
        }

        function getTimeStamp() {
            return moment().format("YYYY-MM-DD HH:mm:ss");
        }

        function url(path) {
            return integration.url("/houmon-kango" + path);
        }

        function getData() {
            let src = $(".houmon-kango-data").val();
            if (!src) {
                src = "{}";
            }
            return JSON.parse(src);
        }

        function setData(data) {
            $(".houmon-kango-data").val(JSON.stringify(data, null, 2));
        }

        setData(clinicParam);

        $("#houmon-kango-leader").on("reset", event => setData(clinicParam));

        function adaptToData() {
            let data = new Data(getData());
            $(".houmon-kango-from-date").val(data.getSubtitle1FromDate());
            $(".houmon-kango-upto-date").val(data.getSubtitle1UptoDate());
            $(".houmon-kango-recipient").val(data.getRecipient());
        }

        $("#houmon-kango-leader").on("reset", event => {
            $(".houmon-kango-from-date").val("");
            $(".houmon-kango-upto-date").val("");
            $(".houmon-kango-recipient").val("");
        });

        $(".houmon-kango-from-date").on("change", event => {
            let data = getData();
            let val = $(event.target).val();
            if (!val) {
                data["subtitle1.from.nen"] = "";
                data["subtitle1.from.month"] = "";
                data["subtitle1.from.day"] = "";
                setData(data);
            } else {
                let wareki = kanjidate.sqldateToData(val);
                data["subtitle1.from.nen"] = wareki.nen;
                data["subtitle1.from.month"] = wareki.month;
                data["subtitle1.from.day"] = wareki.day;
                setData(data);
            }
        });

        $(".houmon-kango-upto-date").on("change", event => {
            let data = getData();
            let val = $(event.target).val();
            if (!val) {
                data["subtitle1.upto.nen"] = "";
                data["subtitle1.upto.month"] = "";
                data["subtitle1.upto.day"] = "";
                setData(data);
            } else {
                let wareki = kanjidate.sqldateToData(val);
                data["subtitle1.upto.nen"] = wareki.nen;
                data["subtitle1.upto.month"] = wareki.month;
                data["subtitle1.upto.day"] = wareki.day;
                setData(data);
            }
        });

        $(".houmon-kango-issue-date").on("change", event => {

            let data = getData();
            let val = $(event.target).val();
            if (!val) {
                data["issue-date.nen"] = "";
                data["issue-date.month"] = "";
                data["issue-date.day"] = "";
                setData(data);
            } else {
                let wareki = kanjidate.sqldateToData(val);
                data["issue-date.nen"] = wareki.nen;
                data["issue-date.month"] = wareki.month;
                data["issue-date.day"] = wareki.day;
                setData(data);
            }
        });

        $(".houmon-kango-recipient").on("change", event => {
            let value = $(event.target).val();
            let data = getData();
            data["recipient"] = value;
            setData(data);
        });

        $(".houmon-kango-issue-date").val(moment().format("YYYY-MM-DD")).trigger("change");

        $(".houmon-kango-create-shijisho-form")
            .attr("action", url("/create-shijisho"));

        $(".houmon-kango-list-param").attr("href", url("/list-params"));

        $("#houmon-kango-select-patient").on("click", async event => {
            let patient = await chooser.choosePatient();
            if (patient) {
                await startPatient(patient);
            }
        });

        async function startPatient(patient) {
            let disp = displayer.disp(patient);
            $("#houmon-kango-patient").html("").append(disp);
            let data = getData();
            data["shimei"] = `${patient.lastName}${patient.firstName}`;
            let birthday = kanjidate.sqldateToData(patient.birthday);
            for (let key of ["birthday.gengou.meiji", "birthday.gengou.taishou",
                "birthday.gengou.shouwa", "birthday.gengou.heisei"]) {
                data[key] = false;
            }
            switch (birthday.gengou) {
                case "明治":
                    data["birthday.gengou.meiji"] = true;
                    break;
                case "大正":
                    data["birthday.gengou.taishou"] = true;
                    break;
                case "昭和":
                    data["birthday.gengou.shouwa"] = true;
                    break;
                case "平成":
                    data["birthday.gengou.heisei"] = true;
                    break;
            }
            data["birthday.nen"] = birthday.nen;
            data["birthday.month"] = birthday.month;
            data["birthday.day"] = birthday.day;
            data["age"] = moment().diff(moment(patient.birthday), "years");
            data["address"] = patient.address;
            setData(data);
            let record = await integration.getHoumonKangoRecord(patient.patientId);
            if (Object.keys(record).length === 0) {
                initRecord(patient.patientId);
            } else {
                setRecord(record);
            }
            updateHistory(getRecordHistory());
        }

        $(".houmon-kango-create-shijisho").on("click", event => {
            let data = $(".houmon-kango-data").val();
            $(".houmon-kango-create-shijisho-form input[name=data]").val(data);
            $(".houmon-kango-create-shijisho-form").submit();
        });

        $(".houmon-kango-save-history").on("click", async event => {
            let data = getData();
            addToRecordHistory(data);
            await saveRecord();
            alert("保存されました。");
            adaptToRecord();
        });

        function fromDateOfData(data) {
            let nen = parseInt(data["subtitle1.from.nen"]);
            let month = parseInt(data["subtitle1.from.month"]);
            let day = parseInt(data["subtitle1.from.day"]);
            if (!isNaN(nen) && !isNaN(month) && !isNaN(day)) {
                let year = kanjidate.gengouToSeireki("令和", nen);
                if (year != null) {
                    return moment({year, month: month - 1, date: day});
                }
            }
            return null;
        }

        function adaptToRecord() {
            updateHistory(getRecordHistory());
        }

        function uptoDateOfData(data) {
            let nen = parseInt(data["subtitle1.upto.nen"]);
            let month = parseInt(data["subtitle1.upto.month"]);
            let day = parseInt(data["subtitle1.upto.day"]);
            if (!isNaN(nen) && !isNaN(month) && !isNaN(day)) {
                let year = kanjidate.gengouToSeireki("令和", nen);
                if (year != null) {
                    return moment({year, month: month - 1, date: day});
                }
            }
            return null;
        }

        function updateHistory(history) {
            let ele = $(".houmon-kango-history");
            let tbody = ele.find("table tbody");
            tbody.html("");
            for (let {stamp, data} of history) {
                let from = fromDateOfData(data);
                let upto = uptoDateOfData(data);
                let recipient = data.recipient;
                let tr = $("<tr>");
                {
                    let td = $("<td>").text(recipient);
                    tr.append(td);
                }
                {
                    let td = $("<td>").text(
                        from ? kanjidate.sqldateToKanji(from.format("YYYY-MM-DD")) : ""
                    );
                    tr.append(td);
                }
                {
                    let td = $("<td>").text(
                        upto ? kanjidate.sqldateToKanji(upto.format("YYYY-MM-DD")) : ""
                    );
                    tr.append(td);
                }
                {
                    let td = $("<td>", {
                        class: "form-inline"
                    });
                    let copyBtn = new $("<button>", {
                        class: "form-control btn btn-secondary"
                    }).text("複製").on("click", event => {
                        setData(data);
                        adaptToData();
                    });
                    let delBtn = new $("<button>", {
                        class: "form-control btn btn-secondary ml-2"
                    }).text("削除").on("click", async event => {
                        if (!confirm("この記録を本当に削除していいですか？")) {
                            return;
                        }
                        removeFromRecordHistory(stamp);
                        await saveRecord();
                        adaptToRecord();
                    });
                    td.append(copyBtn);
                    td.append(delBtn);
                    tr.append(td);
                }
                tbody.append(tr);
            }
        }

        $("#houmon-kango-end-patient").on("click", event => $("#houmon-kango-leader").trigger("reset"));

    }
</script>