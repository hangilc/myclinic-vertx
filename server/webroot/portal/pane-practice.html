<div class="row">
    <h3 class="col-sm-2">診察</h3>
    <div class="col-sm-10">
        <button class="btn btn-secondary practice-choose-patient-button">患者選択</button>
    </div>
</div>

<div class="row practice-wrapper">
    <div class="col-sm-9 practice-main">
        MAIN
    </div>
    <div class="col-sm-3 practice-side">
        SIDE
    </div>
</div>

<template id="practice-search-patient-template">
    <form class="form-inline x-form">
        <input class="form-control x-input"/>
        <button type="submit" class="form-control ml-2">検索</button>
    </form>
    <select class="form-control mt-2 form-control x-select" size="5"></select>
</template>

<template id="practice-choose-patient-dialog-template">
    <div class="modal x-dialog" tabindex="-1" role="dialog" data-backdrop="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">患者選択</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="x-search">
                        <form class="form-inline x-form">
                            <input class="form-control x-input"/>
                            <button type="submit" class="form-control ml-2">検索</button>
                        </form>
                        <select class="form-control mt-2 form-control x-select" size="5"></select>
                    </div>
                    <div class="card mt-2">
                        <div class="card-body">
                            <div class="row x-disp">
                                <div class="col-sm-3">患者番号</div>
                                <div class="col-sm-9 x-patient-id"></div>
                                <div class="col-sm-3">氏名</div>
                                <div class="col-sm-9 x-patient-name"></div>
                                <div class="col-sm-3">よみ</div>
                                <div class="col-sm-9 x-patient-yomi"></div>
                                <div class="col-sm-3">生年月日</div>
                                <div class="col-sm-9 x-patient-birthday"></div>
                                <div class="col-sm-3">性別</div>
                                <div class="col-sm-9 x-patient-sex"></div>
                                <div class="col-sm-3">住所</div>
                                <div class="col-sm-9 x-patient-address"></div>
                                <div class="col-sm-3">電話</div>
                                <div class="col-sm-9 x-patient-phone"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary choose-patient-enter">入力</button>
                    <button type="button" class="btn btn-secondary choose-patient-cancel">キャンセル</button>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    function parseElement(ele) {
        ele = $(ele);
        if (ele.length === 1) {
            let attrClass = ele.attr("class");
            if (attrClass) {
                for (let cls of attrClass.split(/\s+/)) {
                    if (cls.startsWith("x-")) {
                        let name = cls.substring(2);
                        ele.removeClass(cls);
                        let m = {};
                        m[name] = {ele: ele};
                        Object.assign(m[name], parseElement(ele.children()));
                        return m;
                    }
                }
            }
            return parseElement(ele.children());
        } else {
            let map = {};
            for (let e of ele.toArray()) {
                Object.assign(map, parseElement(e));
            }
            return map;
        }
    }

    function parseTemplate(templateId) {
        let ele = $($("template#" + templateId).html());
        return [ele, parseElement(ele)];
    }

    (async function () {
        let ChoosePatientDialog = (await import("./practice/choose-patient-dialog.js")).ChoosePatientDialog;
        let PatientSearch = (await import("./practice/patient-search.js")).PatientSearch;
        let PatientDisplay = (await import("./practice/patient-display.js")).PatientDisplay;

        let choosePatientButtonElement = $(".practice-choose-patient-button");
        let choosePatientDialogElement = $(".choose-patient-dialog");

        choosePatientButtonElement.on("click", async event => {
            let [ele, map] = parseTemplate("practice-choose-patient-dialog-template");
            console.log(map);
            let dialog = new ChoosePatientDialog({
                dialog: ele
            });
            await dialog.open();
            console.log("done");
        });
    })();
</script>