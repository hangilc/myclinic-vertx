<!DOCTYPE html>
<html>
<head>
    <title>Myclinic Portal</title>
    <meta charset="UTF-8">
    <script>$$ = {};</script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/common.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script type="module">
        import * as kanjidate from "./js/kanjidate.js";

        window.kanjidate = kanjidate;
    </script>
    <link rel="stylesheet" href="css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body class="pb-5">
<div class="container">
    <div class="row pt-3 pb-2">
        <h1 class="bg-dark text-white p-3 col-md-12">Myclinic Portal</h1>
    </div>
</div>

<div class="container">

    <div class="row">
        <div class="col-xl-2 sidebar">
            <ul class="list-unstyled menu-elements mt-1">
                <li><a href="javascript:void(0)" class="scroll-link" id="index-practice-link">診察</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-cashier-link">会計</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-reception-link">受付</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-faxed-shohousen-link">ファックス済処方箋</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-houmon-kango-link">訪問看護</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-shujii-link">主治医意見書</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-send-fax-link">ファックス送信</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-printer-setting-link">印刷設定</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-refer-link">紹介状</a></li>
                <li><a href="javascript:void(0)" class="scroll-link" id="index-medcert-link">診断書</a></li>
            </ul>
        </div>

        <div class="col-xl-10" id="index-pane-wrapper"></div>

    </div>
</div>

<script>

    let rest = new Rest("../json");
    let integration = new Integration("../integration");

    window.onerror = message => alert(message);

    class Menu {
        constructor(paneWrapper) {
            this._clearNode(paneWrapper);
            this.paneWrapper = paneWrapper;
            this.itemMap = {};
            this.currentItem = null;
        }

        addItem(name, item) {
            let info = {
                name: name,
                link: item.link,
                savedElement: null,
            };
            this.itemMap[name] = info;
            if( item.init ) {
                item.init(this);
            }
            item.link.onclick = async event => {
                if( name === this.currentItem ){
                    return;
                }
                this._saveCurrentItem();
                this._clearNode(this.paneWrapper);
                if( info.savedElement ){
                    this.paneWrapper.appendChild(info.savedElement);
                    this.currentItem = name;
                    this._setActive(name);
                    if( item.onReloaded ){
                        item.onReloaded(info.savedElement);
                    }
                } else {
                    let pane = document.createElement("div");
                    this._clearNode(this.paneWrapper);
                    this.paneWrapper.appendChild(pane);
                    await item.start(pane, () => {
                        this.currentItem = name;
                        this._setActive(name);
                    });
                }
            };
        }

        _setActive(name){
            Object.keys(this.itemMap).forEach(key => {
                let link = this.itemMap[key].link;
                if( key === name ){
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });
        }

        _clearNode(node){
            if( node ) {
                while (node.firstChild) {
                    node.removeChild(node.firstChild);
                }
            }
        }

        _saveCurrentItem() {
            let c = this.currentItem;
            if( c ) {
                let info = this.itemMap[c];
                info.savedElement = this.paneWrapper.firstElementChild;
                this.paneWrapper.removeChild(info.savedElement);
                this.currentItem = null;
            }
        }
    }

    let menu = new Menu(document.getElementById("index-pane-wrapper"));
    menu.addItem("practice", {
        link: document.getElementById("index-practice-link"),
        async start(pane, cb) {
            let practice = await import("./practice/practice.js");
            pane.innerHTML = practice.getHtml();
            await practice.initPractice();
            cb();
        },
        onReloaded(pane) {
        }
    });
    menu.addItem("cashier", {
        link: document.getElementById("index-cashier-link"),
        async start(pane, cb) {
            let cashier = await import("./cashier/cashier.js");
            pane.innerHTML = cashier.getHtml();
            await cashier.initCashier(pane);
            cb();
        },
        onReloaded(pane) {
            pane.dispatchEvent(new Event("onreloaded"))
        }
    });
    menu.addItem("reception", {
        link: document.getElementById("index-reception-link"),
        async start(pane, cb) {
            let app = await import("./reception/reception.js");
            pane.innerHTML = app.getHtml();
            await app.initReception(pane);
            cb();
        },
        onReloaded(pane) {
            pane.dispatchEvent(new Event("onreloaded"))
        }
    });
    menu.addItem("faxed-shohousen", {
        link: document.getElementById("index-faxed-shohousen-link"),
        async start(pane, cb) {
            let app = await import("./faxed-shohousen/faxed-shohousen.js");
            pane.innerHTML = app.getHtml();
            await app.initFaxedShohousen(pane);
            cb();
        },
        onReloaded(pane) {
            pane.dispatchEvent(new Event("onreloaded"))
        }
    });
    menu.addItem("houmon-kango", {
        link: document.getElementById("index-houmon-kango-link"),
        async start(pane, cb) {
            let app = await import("./houmon-kango/houmon-kango.js");
            await app.initHoumonKango(pane);
            cb();
        },
        onReloaded(pane) {
            pane.dispatchEvent(new Event("onreloaded"))
        }
    });


    let f = (function () {
        let paneWrapper = $("#index-pane-wrapper");
        let currentPane = null;

        class Pane {
            constructor(link, url) {
                this.link = link;
                this.url = url;
                this.ele = null;
                link.on("click", event => this.load());
            }

            save() {
                this.ele = paneWrapper.contents().detach();
            }

            async initPane() {

            }

            onPaneLoaded() {
                paneWrapper.find(".pane").trigger("pane_shown");
                $(".sidebar a.active").removeClass("active");
                this.link.addClass("active");
            }

            disableLinks() {
                $(".sidebar a").addClass("disabled");
            }

            enableLinks() {
                $(".sidebar a").removeClass("disabled");
            }

            async load() {
                if (this.link.hasClass("disabled")) {
                    return;
                }
                if (currentPane === this) {
                    return;
                }
                this.disableLinks();
                if (currentPane) {
                    currentPane.save();
                }
                if (this.ele) {
                    paneWrapper.append(this.ele);
                    currentPane = this;
                    this.onPaneLoaded();
                    this.enableLinks();
                } else {
                    paneWrapper.load(this.url, async () => {
                        currentPane = this;
                        await this.initPane();
                        this.onPaneLoaded();
                        this.enableLinks();
                    });
                }
            }

            async reload() {
                if (this.link.hasClass("disabled")) {
                    return;
                }
                if (currentPane === this) {
                    this.disableLinks();
                    this.ele = null;
                    paneWrapper.load(this.url, async () => {
                        currentPane = this;
                        await this.initPane();
                        this.onPaneLoaded();
                        this.enableLinks();
                    });
                }
            }
        }

        class PracticePane extends Pane {
            constructor() {
                super($("#index-practice-link"), "pane-practice.html");
            }

            async initPane() {
                await super.initPane();
                await initPractice();
            }
        }

        class CashierPane extends Pane {
            constructor() {
                super($("#index-cashier-link"), "pane-cashier.html");
            }

            async initPane() {
                await super.initPane();
                await initCashier();
            }
        }

        class FaxedShohousenPane extends Pane {
            constructor() {
                super($("#index-faxed-link"), "pane-faxed-shohousen.html");
            }

            async initPane() {
                await super.initPane();
                await initFaxedShohousen();
            }
        }

        class ReceptionPane extends Pane {
            constructor() {
                super($("#index-reception-link"), "pane-reception.html");
            }

            async initPane() {
                await super.initPane();
                await initReception();
            }
        }

        class HoumonKangoPane extends Pane {
            constructor() {
                super($("#index-houmon-kango-link"), "pane-houmon-kango.html");
            }

            async initPane() {
                await super.initPane();
                await initHoumonKango();
            }
        }

        class ShujiiPane extends Pane {
            constructor() {
                super($("#index-shujii-link"), "pane-shujii.html");
            }

            async initPane() {
                await super.initPane();
                await initShujii(() => this.reload());
            }
        }

        class SendFaxPane extends Pane {
            constructor() {
                super($("#index-send-fax-link"), "pane-send-fax.html");
            }

            async initPane() {
                await super.initPane();
                await initSendFax();
            }
        }

        class ReferPane extends Pane {
            constructor() {
                super($("#index-refer-link"), "pane-refer.html");
            }

            async initPane() {
                await super.initPane();
                await initRefer();
            }
        }

        class PrinterSettingPane extends Pane {
            constructor() {
                super($("#index-printer-setting-link"), "pane-printer-setting.html");
            }

            async initPane() {
                await super.initPane();
                await initPrinterSetting();
            }
        }

        class MedCertPane extends Pane {
            constructor() {
                super($("#index-medcert-link"), "pane-medcert.html");
            }

            async initPane() {
                await super.initPane();
                await initMedCertPane();
            }
        }

        let practice = new PracticePane();
        let cashier = new CashierPane();
        let reception = new ReceptionPane();
        let faxedShohousen = new FaxedShohousenPane();
        let houmonKango = new HoumonKangoPane();
        let shujii = new ShujiiPane();
        let sendFax = new SendFaxPane();
        let refer = new ReferPane();
        let printerSetting = new PrinterSettingPane();
        let medcert = new MedCertPane();

        practice.link.click();
    });

</script>
</body>
</html>
