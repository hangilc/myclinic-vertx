
<!--
<div id="pane-faxed-shohousen">

    <form>
        <div class="form-inline">
            <span>開始日</span>
            <input type="date" class="form-control ml-1 my-from-date-input"/>
            <span class="ml-2">終了日</span>
            <input type="date" class="form-control ml-1 my-upto-date-input"/>
        </div>
        <div class="form-inline mt-2">
            <button type="button" class="btn btn-primary form-control my-create-button">作成</button>
        </div>
    </form>

    <div class="my-create-data-failure" style="display:none">
        <div class="alert alert-error my-create-data-failure-message"></div>
    </div>

    <ul class="nav nav-tabs mt-3">
        <li class="nav-item">
            <a class="nav-link active" href="javascript:void(0)">処理済一覧</a>
        </li>
    </ul>

    <div class="my-submenu-workarea"></div>

</div>

<script>
    (function(){
        function ajaxGet(url, data){
            return new Promise((resolve, fail) => {
                $.ajax({
                    type: "GET",
                    url: url,
                    data: data,
                    cache: false,
                    dataType: "json",
                    success: resolve,
                    error: (xhr, status, err) => fail(err.getMessage())
                });
            });
        }

        function getElement(className){
            return $("#pane-faxed-shohousen ." + className);
        }

        function getPrevGroups(){
            return ajaxGet("../integration/faxed-shohousen-data/list-groups");
        }

        async function doSubmenuPrevGroups(){
            let prevGroups = await getPrevGroups();
            let ul = $("<ul>");
            if( prevGroups ){
                prevGroups.forEach(group => {
                    let li = $("<li>").text(group);
                    ul.append(li);
                });
            }
            $("#pane-faxed-shohousen .my-submenu-workarea").html("").append(ul);
        }

        async function chooseNextGroup(){
            let prevGroups = await getPrevGroups();
            let momentLast = null;
            prevGroups.forEach(group => {
                let upto = group.split("-")[1];
                let momentUpto = moment(upto, "YYYYMMDD");
                if( momentLast == null ){
                    momentLast = momentUpto;
                } else {
                    if( momentUpto.isAfter(momentLast) ){
                        momentLast = momentUpto;
                    }
                }
            });
            if( momentLast == null ){
                return null;
            } else {
                let momentStart = momentLast.add(1, "day");
                let momentEnd = momentStart.clone();
                if( momentStart.date() < 15 ){
                    momentEnd.date(15);
                } else {
                    momentEnd = momentEnd.endOf("month");
                }
                return {
                    from: momentStart,
                    upto: momentEnd
                }
            }
        }

        async function setup(){
            let nextGroup = await chooseNextGroup();
            if( nextGroup ){
                getElement("my-from-date-input").val(nextGroup.from.format("YYYY-MM-DD"));
                getElement("my-upto-date-input").val(nextGroup.upto.format("YYYY-MM-DD"));
            }
        }

        getElement("my-create-button").on("click", async event => {
            data = {
                from: getElement("my-from-date-input").val(),
                upto: getElement("my-upto-date-input").val()
            };
            let result = await ajaxGet("../integration/faxed-shohousen-data/create-data", data);
            if( result.stderr ){
                let reWithoutPharma = /presc without pharma\s+<Visit\(visit_id='(\d+)'/;
                let match = reWithoutPharma.exec(result.stderr);
                if( match ){
                    let visitId = match[1];
                    console.log("No pharma", visitId);
                    let visit = await ajaxGet("../json/get-visit", {"visit-id": visitId});
                    let patient = await ajaxGet("../json/get-patient", {"patient-id": visit.patientId});
                    let texts = await ajaxGet("../json/list-text", {"visit-id": visitId});
                    console.log(visit, patient, texts);
                } else {
                    console.log(result.stderr);
                }
            }
        });

        setup();
        doSubmenuPrevGroups();

    })();

</script>

-->